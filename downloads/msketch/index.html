
<!doctype html>
<html>
    <head>
            <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
            
            <title>EDISON m.Sketch</title>
            
            <link rel="stylesheet" href="./public/style/spectre.css">
            <link rel="stylesheet" href="./public/style/spectre-exp.css">
            <link rel="stylesheet" href="./public/style/spectre-icons.css">
            
            <link rel="stylesheet" href="./public/style/icon.css" />
            <link rel="stylesheet" href="./public/style/style.css" type="text/css" />
            <script src="./public/js/jquery.min.js"></script>
    </head>
    <body>

        <div class="msketch-titlebar">
        <button class="msketch-titlebar-btn" id="msketch_drawer_open"><i class="material-icons">menu</i></button>
        <span class="msketch-logo">M.SKETCH</span>
        
        <div class="msketch-titlebar-container">
        <button class="msketch-titlebar-btn" id="btn_play" onclick="interfaceSelect(TOOL_RUN);" data-tooltip="Run"><i class="material-icons">play_arrow</i></button>
        <button class="msketch-titlebar-btn" id="btn_save" onclick="showDialog(TOOL_SAVE)" data-tooltip="Save"><i class="material-icons">save</i></button>
        <input id="msketch-titlebar-filename" value="Untitled Sketch"></input>
        </div>
        
        <div class="msketch-titlebar-username"><i class="material-icons">person_pin</i>User Name</div>
        
        </div>
        <div class="msketch-toolbar">
        <div class="msketch-toolbar-container" id="msketch_toolbar">
        <div class="msketch-toolbar-text">Drawing</div>
        <button class="msketch-toolbar-btn" id="btn_link" onclick="interfaceSelect(TOOL_LINK);" data-tooltip="Add Link"><img src="./public/res/icons/btnLink.png"></button>
        <button class="msketch-toolbar-btn" id="btn_ja" onclick="interfaceSelect(TOOL_JA);" data-tooltip="Add Motor"><img src="./public/res/icons/btnJA.png"></button>
        <button class="msketch-toolbar-btn" id="btn_slider" onclick="interfaceSelect(TOOL_SLIDER);" data-tooltip="Set Slider"><img src="./public/res/icons/btnSlider.png"></button>
        <button class="msketch-toolbar-btn" id="btn_mark" onclick="interfaceSelect(TOOL_MARK);" data-tooltip="Toggle Marker"><img src="./public/res/icons/btnMark.png"></button>
        <button class="msketch-toolbar-btn" id="btn_move" onclick="interfaceSelect(TOOL_MOVE);" data-tooltip="Edit Link"><img src="./public/res/icons/btnMove.png"></button>
        <button class="msketch-toolbar-btn" id="btn_remove" onclick="interfaceSelect(TOOL_REMOVE);" data-tooltip="Remove Part"><i class="material-icons">delete_forever</i></button>
        <div class="msketch-toolbar-spacer">|</div>
        <div class="msketch-toolbar-text">Navigation</div>
        <button class="msketch-toolbar-btn" id="btn_nav" onclick="interfaceSelect(TOOL_NAV);" data-tooltip="Toggle View Tumbling"><i class="material-icons">3d_rotation</i></button>
        <button class="msketch-toolbar-btn" id="btn_pcam" onclick="interfaceSelect(TOOL_PCAM);" data-tooltip="See Plane on Top"><i class="material-icons">fullscreen</i></button>
        <button class="msketch-toolbar-btn" id="btn_pcam" onclick="setViewMode(0);" data-tooltip="Schematic View"><img src="./public/res/icons/btnSchematicView.png"></button>
        <button class="msketch-toolbar-btn" id="btn_pcam" onclick="setViewMode(1);" data-tooltip="Part View"><img src="./public/res/icons/btnPartsView.png"></button>
        <div class="msketch-toolbar-spacer">|</div>
        <div class="msketch-toolbar-text">History</div>
        <button class="msketch-toolbar-btn" id="btn_nav" onclick="undo();" data-tooltip="Undo"><i class="material-icons">chevron_left</i></button>
        <button class="msketch-toolbar-btn" id="btn_pcam" onclick="redo();" data-tooltip="Redo"><i class="material-icons">chevron_right</i></button>
        <div class="msketch-toolbar-spacer">|</div>
        <div class="msketch-toolbar-text">Plane</div>
        <button class="msketch-toolbar-btn" id="btn_padd" onclick="interfaceSelect(TOOL_PADD);" data-tooltip="Add Plane"><img src="./public/res/icons/btnPAdd.png"></button>
        <button class="msketch-toolbar-btn" id="btn_premove" onclick="showDialog(TOOL_PREMOVE);" data-tooltip="Remove Plane"><img src="./public/res/icons/btnPRemove.png"></button>
        <button class="msketch-toolbar-btn" id="btn_psel" onclick="interfaceSelect(TOOL_PSEL);" data-tooltip="Select Plane"><img src="./public/res/icons/btnPSel.png"></button>
        <button class="msketch-toolbar-btn" id="btn_ptrans" onclick="interfaceSelect(TOOL_PTRANS);" data-tooltip="Plane Translation"><img src="./public/res/icons/btnPTrans.png"></button>
        <button class="msketch-toolbar-btn" id="btn_prot" onclick="interfaceSelect(TOOL_PROT);" data-tooltip="Plane Rotation"><img src="./public/res/icons/btnPRot.png"></button>
        <button class="msketch-toolbar-btn" id="btn_prot" onclick="interfaceSelect(TOOL_PCOPY);" data-tooltip="Copy This Plane"><img src="./public/res/icons/btnPCopy.png"></button>
        </div>
        
        </div>
        
        <div class="msketch-drawer" id="msketch_drawer">
        <button class="msketch-drawer-btn" onclick="showDialog(TOOL_NEWFILE);"><i class="material-icons">insert_drive_file</i>New</button>
        <button class="msketch-drawer-btn" onclick="showDialog(TOOL_SAVE);"><i class="material-icons">save</i>Save</button>
        <button class="msketch-drawer-btn" onclick="showDialog(TOOL_OPEN);"><i class="material-icons">folder_open</i>Open</button>
        <button class="msketch-drawer-btn" onclick="interfaceSelect(TOOL_EXPORT);"><i class="material-icons">file_download</i>Export Plane</button>
        <button class="msketch-drawer-btn" onclick="showDialog(TOOL_IMPORT);"><i class="material-icons">file_upload</i>Import Plane</button>
        <button class="msketch-drawer-btn" onclick="interfaceSelect(TOOL_DRAWING);"><i class="material-icons">picture_as_pdf</i>Export Drawing</button>
        <button class="msketch-drawer-btn" onclick="location.href='logout';"><i class="material-icons">cloud_off</i>Logout</button>
        <button class="msketch-drawer-btn" onclick="$('#msketch_about').show();"><i class="material-icons">info_outline</i>About</button>
        </div>
        
        <div class="msketch-sidebar">
        <button class="msketch-toolbar-btn" id="btn_panel_move" data-tooltip-side="Position Panel"><i class="material-icons">open_with</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_plane" data-tooltip-side="Plane Panel"><i class="material-icons">layers</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_motor" data-tooltip-side="Motor Panel"><i class="material-icons">slow_motion_video</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_pattern" data-tooltip-side="Pattern Panel"><i class="material-icons">filter_tilt_shift</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_analysis" data-tooltip-side="Walking Analysis Panel"><i class="material-icons">multiline_chart</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_opt" data-tooltip-side="Path Optimization Panel"><i class="material-icons">gesture</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_fab" data-tooltip-side="Fabrication Panel"><i class="material-icons">build</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_gen" data-tooltip-side="Linkage Generation Panel"><i class="material-icons">linear_scale</i></button>
        <button class="msketch-toolbar-btn" id="btn_panel_load" data-tooltip-side="Load Panel"><i class="material-icons">play_for_work</i></button>
        <button class="msketch-toolbar-btn" id="btn_settings" data-tooltip-side="Settings"><i class="material-icons">settings</i></button>
        </div>
        
        <div class="msketch-panel" id="msketch_panel">
        <div class="msketch-panel-container" id="panel_move" style="display: none">
        <div class="msketch-panel-title">Point &amp; Link<br>Position</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="x" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_move_x" disabled>
        </div>
        <div class="msketch-panel-label" data-label="y" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_move_y" disabled>
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Length" style="width: 100%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_move_length" disabled>
        </div>
        </div>
        
        <div class="msketch-panel-row">
        <label class="form-switch">
        <input type="checkbox" id="panel_move_sbGrid">
        <i class="form-icon"></i> <span class="msketch-panel-desc">ScienceBox Grid &amp; Snap</span>
        </label>
        <label class="form-switch">
        <input type="checkbox" id="panel_move_sbSnap">
        <i class="form-icon"></i> <span class="msketch-panel-desc">ScienceBox Unit Conversion</span>
        </label>
        </div>
        
        <button class="msketch-panel-btn-large" id="panel_move_apply"><i class="material-icons">done</i>Apply</button>
        </div>
        
        <script>
        // === Postion Panel ===
        $('#panel_move_sbGrid').on('change', function(){
            if( $("#panel_move_sbGrid").prop("checked") ){
                isScienceBoxSanpOn = true;
                currentAssemblyGroup.showSBGrid();
            }else{
                isScienceBoxSanpOn = false;
                currentAssemblyGroup.hideSBGrid();
            }
        });

        $('#panel_move_sbSnap').on('change', function(){
            if( $("#panel_move_sbSnap").prop("checked") ){
                isScienceBoxLinkOn = true;
            }else{
                isScienceBoxLinkOn = false;
            }
        });

        $('#panel_move_apply').click( function(){
            applyMove();
            applyLength();
        });

        $('#panel_move').keyup(function(event){
            if (event.keyCode == 13) {
                applyMove();
                applyLength();
            }
        });

        var prevPosition 	= [];
        var prevPointPair 	= null;

        function getPointInfoToMovePanel(){
            if(!(toolState==TOOL_MOVE)) return;
            
            if(selectedPoint!=null){
                $('#panel_move_x').prop('disabled', false);
                $('#panel_move_y').prop('disabled', false);
                $('#panel_move_length').prop('disabled', true);

                $('#panel_move_x').val( (selectedPoint.x*SCALE_TRANS).toFixed(2) );
                $('#panel_move_y').val( (selectedPoint.y*SCALE_TRANS).toFixed(2) );
                $('#panel_move_length').val( null );

                prevPosition[0] = selectedPoint.x;
                prevPosition[1] = selectedPoint.y;
                selectedPoint = null;
                prevPointPair = null;
            }

            // for length
            if(selectedPointPair!=null && prevPointPair!=selectedPointPair){
                $('#panel_move_x').prop('disabled', true);
                $('#panel_move_y').prop('disabled', true);
                $('#panel_move_length').prop('disabled', false);

                var _length = selectedPointPair[0].distance(selectedPointPair[1].getX(), selectedPointPair[1].getY());

                $('#panel_move_x').val( null );
                $('#panel_move_y').val( null );
                $('#panel_move_length').val( (_length*SCALE_TRANS).toFixed(2) );

                prevPointPair = selectedPointPair;
                selectedPoint = null;
                currentAssemblyGroup.setSegmentSelected(selectedLink, selectedPointPair);
            }

            if(selectedPointTg==null){
                prevPosition[0] = null;
                prevPosition[1] = null;
            }

            if(selectedPointPair==null){
                selectedLink = null;
                prevPointPair = null;
            }
        } // function getPointInfoToMovePanel

        function applyMove(){
            if(selectedPointTg==null) return;

            var newPosX = parseFloat($('#panel_move_x').val())/SCALE_TRANS;
            var newPosY = parseFloat($('#panel_move_y').val())/SCALE_TRANS;
            if(!isNaN(newPosX) && !isNaN(newPosY)){
                currentInterface.mouseMove(prevPosition[0], prevPosition[1]);
                currentInterface.mouseDown(prevPosition[0], prevPosition[1]);
                currentInterface.mouseDownAndMoveFirst(prevPosition[0], prevPosition[1]);
                currentInterface.mouseDownAndMove(newPosX, newPosY);
                currentInterface.mouseMoveAndUp(newPosX, newPosY);
            }
        } // function applyMove

        function applyLength(){
            if(selectedLink==null || selectedPointPair==null) return;

            var newLength = parseFloat($('#panel_move_length').val())/SCALE_TRANS;

            setLengthToLink(selectedLink, selectedPointPair[0], selectedPointPair[1], newLength);
            currentAssemblyGroup.setSegmentSelected(selectedLink, selectedPointPair);
        } // function applyLength

        </script>
        
        <div class="msketch-panel-container" id="panel_plane" style="display: none">
        <div class="msketch-panel-title">Plane Position<br>&amp; Rotation</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="tx" style="width: 32%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_plane_tx">
        </div>
        <div class="msketch-panel-label" data-label="ty" style="width: 32%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_plane_ty">
        </div>
        <div class="msketch-panel-label" data-label="tz" style="width: 32%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_plane_tz">
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="rx" style="width: 32%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_plane_rx">
        </div>
        <div class="msketch-panel-label" data-label="ry" style="width: 32%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_plane_ry">
        </div>
        <div class="msketch-panel-label" data-label="rz" style="width: 32%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_plane_rz">
        </div>
        </div>
        
        <button class="msketch-panel-btn-large" id="panel_plane_apply"><i class="material-icons">done</i>Apply</button>
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large" id="panel_plane_flipHor" style="width: 47%; display:inline-block; float: left"><i class="material-icons">flip</i>Flip Hor</button>
        <button class="msketch-panel-btn-large" id="panel_plane_flipVert" style="width: 47%; display:inline-block; float: right"><i class="material-icons" style="transform: rotate(90deg); padding-right: 0; height: 29px">flip</i>Flip Vert</button>
        </div>
        </div>
        
        <script>
        $('#panel_plane_apply').click( function(){
            applyPlane();
        });

        $('#panel_plane').keyup(function(event){
            if (event.keyCode == 13) {
                applyPlane();
            }
        });

        $('#panel_plane_flipHor').click( function(){
            planeData = currentAssemblyGroup.getPositionData();
            planeData.ry = planeData.ry + Math.PI;
            currentAssemblyGroup.setPositionData(planeData);
        });
        $('#panel_plane_flipVert').click( function(){
            planeData = currentAssemblyGroup.getPositionData();
            planeData.rx = planeData.rx + Math.PI;
            currentAssemblyGroup.setPositionData(planeData);
        });

        function getPlaneInfoToPlanePanel(){
            //if(!(toolState==TOOL_PTRANS || toolState==TOOL_PROT)) return;

            planeData = currentAssemblyGroup.getPositionData();

            $('#panel_plane_tx').val( (planeData.tx*SCALE_TRANS).toFixed(2) );
            $('#panel_plane_ty').val( (planeData.ty*SCALE_TRANS).toFixed(2) );
            $('#panel_plane_tz').val( (planeData.tz*SCALE_TRANS).toFixed(2) );
            $('#panel_plane_rx').val( Math.degrees(planeData.rx).toFixed(2) );
            $('#panel_plane_ry').val( Math.degrees(planeData.ry).toFixed(2) );
            $('#panel_plane_rz').val( Math.degrees(planeData.rz).toFixed(2) );
        }

        function applyPlane(){
            var tempData = {};
            tempData.tx = (parseFloat($('#panel_plane_tx').val())/SCALE_TRANS);
            tempData.ty = (parseFloat($('#panel_plane_ty').val())/SCALE_TRANS);
            tempData.tz = (parseFloat($('#panel_plane_tz').val())/SCALE_TRANS);
            tempData.rx = Math.radians(parseFloat($('#panel_plane_rx').val()));
            tempData.ry = Math.radians(parseFloat($('#panel_plane_ry').val()));
            tempData.rz = Math.radians(parseFloat($('#panel_plane_rz').val()));
            currentAssemblyGroup.setPositionData(tempData);
         }

        </script>
        
        <div class="msketch-panel-container" id="panel_motor" style="display: none">
        <div class="msketch-panel-title">Motor<br>Setting</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Unit Speed (deg/s)" style="width: 100%; vertical-align: bottom">
        <input class="form-input msketch-panel-input" type="text" id="motor_gspeed_txt" value="180" style="width: 20%;">
        <input class="slider msketch-panel-slider" type="range" id="motor_gspeed_slider" min="0" max="720" value="180" style="width: 70%;"/>
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Motor List" style="width: 100%;">
        <select id="motor_list" class="form-select msketch-panel-select">
        </select>
        </div>
        </div>
        <hr>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label motor-both disableClick" data-label="Motor Type" style="width: 100%; vertical-align: bottom">
        <label class="form-radio" style="width: 49%;">
        <input type="radio" name="gender" id="motor_type_dc" checked>
        <i class="form-icon"></i> <span class="msketch-panel-desc">DC Motor</span>
        </label>
        <label class="form-radio" style="width: 49%;">
        <input type="radio" name="gender" id="motor_type_servo" >
        <i class="form-icon"></i> <span class="msketch-panel-desc">Servo Motor</span>
        </label>
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label motor-both disableClick" data-label="Motor Phase (deg)" style="width: 100%; vertical-align: bottom">
        <input class="form-input msketch-panel-input" type="text" id="motor_phase_txt" style="width: 20%;">
        <input class="slider msketch-panel-slider" type="range" id="motor_phase_slider" min="0" max="360" value="0" style="width: 70%;"/>
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label motor-both disableClick" data-label="Speed Multiply (%)" style="width: 100%; vertical-align: bottom">
        <input class="form-input msketch-panel-input" type="text" id="motor_speed_txt" style="width: 20%;">
        <input class="slider msketch-panel-slider" type="range" id="motor_speed_slider" min="0" max="400" value="100" style="width: 70%;"/>
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label motor-servo disableClick" data-label="Min Angle (deg)" style="width: 100%; vertical-align: bottom">
        <input class="form-input msketch-panel-input" type="text" id="motor_min_txt" style="width: 20%;">
        <input class="slider msketch-panel-slider" type="range" id="motor_min_slider" min="0" max="360" value="0" style="width: 70%;"/>
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label motor-servo disableClick" data-label="Max Angle (deg)" style="width: 100%; vertical-align: bottom">
        <input class="form-input msketch-panel-input" type="text" id="motor_max_txt" style="width: 20%;">
        <input class="slider msketch-panel-slider" type="range" id="motor_max_slider" min="0" max="360" value="180" style="width: 70%;"/>
        </div>
        </div>
        <div class="msketch-panel-row">
        <label class="form-switch motor-dc disableClick">
        <input type="checkbox" id="motor_reverse">
        <i class="form-icon"></i> <span class="msketch-panel-desc">Reverse Direction</span>
        </label>
        </div>
        </div>
        
        <style>
        .msketch-panel-slider{
        display:inline-block;
        margin-left: 12px;
        vertical-align: middle;
        }
        .msketch-panel-input{
        vertical-align: middle;
        }
        </style>
        
        <script>
        $('#motor_gspeed_txt').on('change', function(){
            motorSpeed = Math.radians( parseInt( $(this).val() ) );
            $('#motor_gspeed_slider').val( $(this).val() );
        });

        $('#motor_gspeed_slider').on('input change', function(){
            motorSpeed = Math.radians( parseInt( $(this).val() ) );
            $('#motor_gspeed_txt').val( $(this).val() );
        });

        $('#motor_list').on('mousedown', function(){
            updateMotorList();
        });

        $('#motor_list').on('change', function(){
            updateMotorInfo();
        });

        $('#motor_type_dc').on('change', function(){
            if($(this).prop('checked')){
                pointedActuator.setDC();
                updateMotorInfo();
                try360forAssemblies();
            }
        });

        $('#motor_type_servo').on('change', function(){
            if($(this).prop('checked')){
                pointedActuator.setServo();
                updateMotorInfo();
                try360forAssemblies();
            }
        });

        $('#motor_phase_txt').on('change', function(){
            pointedActuator.setPhase(Math.radians(parseInt($(this).val())));
        if(pointedActuator.isServo) applyActuator(pointedActuator, parseInt( $(this).val() ) + parseInt( $("#motor_min_txt").val() ));
            else applyActuator(pointedActuator, $(this).val());
            $('#motor_phase_slider').val( $(this).val() );
        });

        $('#motor_phase_slider').on('input change', function(){
            pointedActuator.setPhase(Math.radians(parseInt($(this).val())));
            if(pointedActuator.isServo) applyActuator(pointedActuator, parseInt( $(this).val() ) + parseInt( $("#motor_min_txt").val() ));
            else applyActuator(pointedActuator, $(this).val());
            $('#motor_phase_txt').val( $(this).val() );
        });

        $('#motor_speed_txt').on('change', function(){
            pointedActuator.setSpeedMultiply(parseInt( $(this).val() ) / 100);
        $('#motor_speed_slider').val( $(this).val() );
        });

        $('#motor_speed_slider').on('input change', function(){
            pointedActuator.setSpeedMultiply(parseInt( $(this).val() ) / 100);
        $('#motor_speed_txt').val( $(this).val() );
        });

        $('#motor_min_txt').on('change', function(){
            pointedActuator.setStartAngle(Math.radians(parseInt( $(this).val() )));
            applyActuator(pointedActuator, parseInt( $(this).val() ) + parseInt( $("#motor_phase_txt").val() ));
            $('#motor_min_slider').val( $(this).val() );
        });

        $('#motor_min_slider').on('input change', function(){
            pointedActuator.setStartAngle(Math.radians(parseInt( $(this).val() )));
            applyActuator(pointedActuator, parseInt( $(this).val() ) + parseInt( $("#motor_phase_txt").val() ));
        $('#motor_min_txt').val( $(this).val() );
        });

        $('#motor_max_txt').on('change', function(){
            pointedActuator.setEndAngle(Math.radians(parseInt( $(this).val() )));
            applyActuator(pointedActuator, parseInt( $("#motor_min_txt").val() ) + parseInt( $("#motor_phase_txt").val() ));
        $('#motor_max_slider').val( $(this).val() );
        });

        $('#motor_max_slider').on('input change', function(){
            pointedActuator.setEndAngle(Math.radians(parseInt( $(this).val() )));
            applyActuator(pointedActuator, parseInt( $("#motor_min_txt").val() ) + parseInt( $("#motor_phase_txt").val() ));
            $('#motor_max_txt').val( $(this).val() );
        });


        $('#motor_reverse').on('change', function(){
            pointedActuator.setReverse( $(this).prop('checked') );
        })


        function updateMotorList(){
            $('#motor_list').empty();
            $.each(getActuatorName(), function (i, item) {
                $('#motor_list').append($('<option>', {
                    value: i,
                    text : item
                }));
            });
            $('#motor_list').val(null);

            $('.motor-both').addClass('disableClick');
            $('.motor-servo').addClass('disableClick');
            $('.motor-dc').addClass('disableClick');
        }

        function updateMotorInfo(){
            var a = null;
            var _motorType = 0;
            
            var _selectedIndex = parseInt( $('#motor_list').val() );


            if (_selectedIndex != -1) {
                a = findJAfromName( $('#motor_list option:selected').text() );
            }

            if (a == null) {
                showMessage("Motor not found.")
                // close other panel
            return;
            } else {
            if (!a.isServo) _motorType = 0;
            else _motorType = 1;
            pointedActuator = a;
            }

            // Show motor selection
            $('.motor-both').removeClass('disableClick');

            // get motor type
            if(_motorType == 0){
                $('#motor_type_dc').prop('checked', true);
                $('#motor_type_servo').prop('checked', false);
                $('.motor-servo').addClass('disableClick')
                $('.motor-dc').removeClass('disableClick');
            }else{
                $('#motor_type_dc').prop('checked', false);
                $('#motor_type_servo').prop('checked', true);
                $('.motor-dc').addClass('disableClick')
                $('.motor-servo').removeClass('disableClick');
            }

            $('#motor_phase_txt').val( Math.round(Math.degrees(a.getPhase())) );
            $('#motor_speed_txt').val( Math.round(a.getSpeedMultiply() * 100) );
            $('#motor_min_txt').val( Math.round(Math.degrees(a.getStartAngle())) );
            $('#motor_max_txt').val( Math.round(Math.degrees(a.getEndAngle())) );

            if(a.getReverse()) $('#motor_reverse').prop('checked', true);
            else $('#motor_reverse').prop('checked', false);

            $('#motor_phase_slider').val( $('#motor_phase_txt').val() );
            $('#motor_speed_slider').val( $('#motor_speed_txt').val() );
            $('#motor_min_slider').val( $('#motor_min_txt').val() );
            $('#motor_max_slider').val( $('#motor_max_txt').val() );
        }

        function getActuatorName() {
            var returnValue = [];

        for (i = 0; i < AssemblyGroupList.length; i++) {
            var _actuatorList = AssemblyGroupList[i].assembly.getAllActuator();

            if (_actuatorList != null) {
                for (var ai in _actuatorList.array) {
                    var a = _actuatorList.get(ai);
                    if (a instanceof JointActuator) {
                        returnValue.push(a.getName() + " on Plane" + i);
                    }
                }
            }
        }

            return returnValue;
        }

        function findJAfromName(_fullName) {
            if (_fullName == '' || _fullName == null) return null;
            
            _name = _fullName.split(" on Plane")[0]
            _index = parseInt(_fullName.split(" on Plane")[1]);
            
            var _actuatorList = AssemblyGroupList[_index].assembly.getAllActuator();

            if (_actuatorList != null) {
                for (var ai in _actuatorList.array) {
                    var a = _actuatorList.get(ai);
                    if (a instanceof JointActuator) {
                        if (a.getName() == _name) return a;
                    }
                }
            }

            return null;
        }

        function applyActuator(_a, _value) {
            _a.setValue(Math.radians(parseInt(_value)));
            for (var i = 0; i < AssemblyGroupList.length; i++) {
                var _actuatorList = AssemblyGroupList[i].assembly.getAllActuator();
            
                if (_actuatorList.contains(_a)) {
                    AssemblyGroupList[i].calculateAssembly();
                }
            }
            try360forAssemblies();
            currentAssemblyGroup.removeSegmentSelected();
        }

        </script>
        
        <div class="msketch-panel-container" id="panel_pattern" style="display: none">
        <div class="msketch-panel-title">Pattern<br>Generation</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Axis (World Coordinate)" style="width: 100%;">
        <label class="form-radio" style="width: 32%;">
        <input type="radio" name="gender" id="panel_pattern_x" checked>
        <i class="form-icon"></i> <span class="msketch-panel-desc">x</span>
        </label>
        <label class="form-radio" style="width: 32%;">
        <input type="radio" name="gender" id="panel_pattern_y" >
        <i class="form-icon"></i> <span class="msketch-panel-desc">y</span>
        </label>
        <label class="form-radio" style="width: 32%;">
        <input type="radio" name="gender" id="panel_pattern_z">
        <i class="form-icon"></i> <span class="msketch-panel-desc">z</span>
        </label>
        </div>
        </div>
        
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Angle" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_pattern_angle">
        </div>
        <div class="msketch-panel-label" data-label="Amount" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_pattern_amount">
        </div>
        </div>
        
        <button class="msketch-panel-btn-large" id="panel_pattern_apply"><i class="material-icons">done</i>Make</button>
        </div>
        
        <script>
        $('#panel_pattern_apply').click( function(){
        createPattern();
        });
        $('#panel_pattern_angle').on('change keyup paste', function(){
        setPatternAmount();
        })

        function setPatternAmount(){
        if( $('#panel_pattern_angle').val() == "" || $('#panel_pattern_angle').val() == null ){
        $('#panel_pattern_amount').val( null );
        }else{
        $('#panel_pattern_amount').val( parseInt( 360/parseFloat( $('#panel_pattern_angle').val() ) ) );
        }
        }

        function getSelectedAxis(){
        if( $('#panel_pattern_x').prop('checked') ){
        return 'x';
        }
        else if( $('#panel_pattern_y').prop('checked') ){
        return 'y';
        }
        else if( $('#panel_pattern_z').prop('checked') ){
        return 'z';
        }

        return null;
        }


        function createPattern(){

        if( $('#panel_pattern_angle').val() == "" || $('#panel_pattern_angle').val() == null ||
        $('#panel_pattern_amount').val() == "" || $('#panel_pattern_amount').val() == null ) return false;

        if(isPlaying)	interfaceSelect(TOOL_RUN);

        // get Axis
        var selectedAxis = getSelectedAxis();


        var patternAmount = parseInt( $('#panel_pattern_amount').val() );

        var _data = getMsketchInfoForPlane();

        for(var i=1; i<patternAmount; i++){

        var _dataJSON = JSON.parse(_data);

        var _dist, _startAngle, _rotatedAngle;
        var _x = parseFloat( _dataJSON.sketch.plane.translation.x ),
        _y = parseFloat( _dataJSON.sketch.plane.translation.y ),
        _z = parseFloat( _dataJSON.sketch.plane.translation.z ),
        _rx = parseFloat( _dataJSON.sketch.plane.rotation.x ),
        _ry = parseFloat( _dataJSON.sketch.plane.rotation.y ),
        _rz = parseFloat( _dataJSON.sketch.plane.rotation.z );

        var _stepAngle = Math.radians( parseFloat( $('#panel_pattern_angle').val() ) );

        switch(selectedAxis){
        case 'x':
        _dist = Math.sqrt((_y)*(_y) + (_z)*(_z));
        _startAngle = Math.atan2(_z, _y);
        _rotatedAngle = rotateAroundWorldAxis(new THREE.Vector3(1,0,0), _stepAngle*i,
        Math.radians(_rx), Math.radians(_ry), Math.radians(_rz));

        _dataJSON.sketch.plane.translation.x = _x;
        _dataJSON.sketch.plane.translation.y = _dist*Math.cos(_startAngle+_stepAngle*i);
        _dataJSON.sketch.plane.translation.z = _dist*Math.sin(_startAngle+_stepAngle*i);
        _dataJSON.sketch.plane.rotation.x = Math.degrees( _rotatedAngle[0] );
        _dataJSON.sketch.plane.rotation.y = Math.degrees( _rotatedAngle[1] );
        _dataJSON.sketch.plane.rotation.z = Math.degrees( _rotatedAngle[2] );

        break;
        case 'y':
        _dist = Math.sqrt((_x)*(_x) + (_z)*(_z));
        _startAngle = Math.atan2(_z, _x);
        _rotatedAngle = rotateAroundWorldAxis(new THREE.Vector3(0,1,0), -_stepAngle*i,
        Math.radians(_rx), Math.radians(_ry), Math.radians(_rz));

        _dataJSON.sketch.plane.translation.x = _dist*Math.cos(_startAngle+_stepAngle*i);
        _dataJSON.sketch.plane.translation.y = _y;
        _dataJSON.sketch.plane.translation.z = _dist*Math.sin(_startAngle+_stepAngle*i);
        _dataJSON.sketch.plane.rotation.x = Math.degrees( _rotatedAngle[0] );
        _dataJSON.sketch.plane.rotation.y = Math.degrees( _rotatedAngle[1] );
        _dataJSON.sketch.plane.rotation.z = Math.degrees( _rotatedAngle[2] );
        break;
        case 'z':
        _dist = Math.sqrt((_x)*(_x) + (_y)*(_y));
        _startAngle = Math.atan2(_y, _x);
        _rotatedAngle = rotateAroundWorldAxis(new THREE.Vector3(0,0,1), _stepAngle*i,
        Math.radians(_rx), Math.radians(_ry), Math.radians(_rz));
        _dataJSON.sketch.plane.translation.x = _dist*Math.cos(_startAngle+_stepAngle*i);
        _dataJSON.sketch.plane.translation.y = _dist*Math.sin(_startAngle+_stepAngle*i);
        _dataJSON.sketch.plane.translation.z = _z;
        _dataJSON.sketch.plane.rotation.x = Math.degrees( _rotatedAngle[0] );
        _dataJSON.sketch.plane.rotation.y = Math.degrees( _rotatedAngle[1] );
        _dataJSON.sketch.plane.rotation.z = Math.degrees( _rotatedAngle[2] );
        break;
        }
        importPlaneInfo( JSON.stringify(_dataJSON) , true);
        }
        checkHistory();

        }

        function rotateAroundWorldAxis(axis, angle, _x, _y, _z) {
        var object = new THREE.Object3D();
        object.rotation.x = _x;
        object.rotation.y = _y;
        object.rotation.z = _z;

        var q = new THREE.Quaternion();
        q.setFromAxisAngle( axis, angle ); // axis must be normalized, angle in radians
        object.quaternion.multiplyQuaternions( q, object.quaternion );
        return [object.rotation.x, object.rotation.y, object.rotation.z];
        }


        </script>
        
        <div class="msketch-panel-container" id="panel_analysis" style="display: none">
        <div class="msketch-panel-title">Walking Path<br>Analysis</div>
        
        <div class="msketch-panel-row">
        <img src="./public/res/desAnalysis.png" style="width: 100%; padding: 16px; background-color: #fff; border-radius: 5px">
        </div>
        
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc">Analyze strides with marked points on designed mechanism. Movement for analysis is not affected by motor setting.</div>
        </div>
        
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large" id="panel_analysis_run"><i class="material-icons">done</i>Run</button>
        <button class="msketch-panel-btn-large" id="panel_analysis_stop"><i class="material-icons">stop</i>Stop</button>
        </div>
        <hr>
        <div class="msketch-panel-row">
        <div class="panel-analysis-result-container header">
        <div class="msketch-panel-desc" style="width: 15%;">Color</div>
        <div class="msketch-panel-desc" style="width: 40%;">Ground Length</div>
        <div class="msketch-panel-desc" style="width: 40%;">Angle Coefficient</div>
        </div>
        <div id="panel_analysis_result"></div>
        </div>
        </div>
        
        <style>
        .panel-analysis-result-container > div {
        display: inline-block;
        font-size: 13px;
        margin-bottom: 6px;
        vertical-align: middle;
        float: left;
        }
        .panel-analysis-result-container.header > div{
        font-weight: 700;
        color: #555;
        }
        .panel-analysis-bullet{
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #888;
        }
        </style>
        
        <script>
        var TRAJECTORY_COLORS = ['#671eac', '#E94F35', '#2ACA6B', '#F4C300', '#438CDE'];
        var TRAJECTORY_COLORS_THREE = [0x671eac, 0xE94F35, 0x2ACA6B, 0xF4C300, 0x438CDE];

        $('#panel_analysis_run').click( function(){
            runAnalysis();
            showMessage("Analysis started.");
        });

        $('#panel_analysis_stop').click( function(){
            stopAnalysis();
            showMessage("Analysis stopped.");
        });


        function getAnalysisInfo(){ // called in main.js actuate();
            if(!isAnalysisOn) return;
            
            var tCount = 0;
            
            $('#panel_analysis_result').empty();

        for(i=0; i<AssemblyGroupList.length; i++){
            var _trajectoryList = AssemblyGroupList[i].getTrajectory();
            if(_trajectoryList==null) return;
                for(var ti in _trajectoryList.array){
                    var t = _trajectoryList.get(ti);
            
                    AssemblyGroupList[i].trajectoryObjList[ti].setColor(TRAJECTORY_COLORS_THREE[tCount%TRAJECTORY_COLORS_THREE.length]);
            
                    $('#panel_analysis_result').append('<div class="panel-analysis-result-container">'
                    + '<div class="msketch-panel-desc" style="width: 15%;"><div class="panel-analysis-bullet" style="background-color: ' + TRAJECTORY_COLORS[tCount%TRAJECTORY_COLORS.length] + '"></div></div>'
                    + '<div class="msketch-panel-desc" style="width: 40%;">' + (parseFloat(groundInfo(t)[0])*SCALE_TRANS).toFixed(3)     + ' mm </div>'
                    + '<div class="msketch-panel-desc" style="width: 40%;">' + parseFloat(groundInfo(t)[1]).toFixed(3)                   + '</div></div>'
                    )
            
                    tCount++;
                }
            }
        }

        function runAnalysis(){
            if(isPlaying){
                interfaceSelect(TOOL_RUN);
            }
            isAnalysisOn = true;
            interfaceSelect(TOOL_RUN);
        }

        function stopAnalysis(){
            isAnalysisOn = false;
            if(isPlaying){
                interfaceSelect(TOOL_RUN);
            }
        }


        function groundInfo(_trajectoryObject){
            var groundLength;
            var groundAngleCo;
            var returnValue = new Array();
            
            var _tan 	= [];
            var _angle 	= [];
            var _x 		= [];
            var _y 		= [];
            //var _pm		= [];	//*	Not used in this version

            var inputTrajectory = _trajectoryObject.getTrajectoryOneCycle();
            //inputTrajectory.splice(0,1);
            
            //* Parsing "angle/x/y" from the Trajectory.trajectoryOneCycle [elements/Trajectory.js]
            for(var j=0; j<inputTrajectory.length; j++){
                var res = inputTrajectory[j].split('/');
                _angle.push(res[0]);
                _x.push(res[1]);
                _y.push(res[2]);
            }

            var tempTan = (_y[2]-_y[1])/(_x[2]-_x[1]);

            for(var j=0; j<inputTrajectory.length-1; j++){
                _tan.push((_y[j+1]-_y[j])/(_x[j+1]-_x[j]));
            
                if(tempTan < ( (_y[j+1] - _y[j]) / (_x[j+1] - _x[j]) ) ){
                    tempTan=(_y[j+1] - _y[j]) / (_x[j+1] - _x[j]);
                }
            }


            var tempno	= _tan.indexOf(tempTan);
            var tanup 	= _tan.slice(0,tempno);
            var tandown = _tan.slice(tempno,_tan.length+1);
            var newtan 	= tandown.concat(tanup);
            
            var aup 	= _angle.slice(0,tempno);
            var adown 	= _angle.slice(tempno,_angle.length+1);
            var newa 	= adown.concat(aup);
            
            var xup 	= _x.slice(0,tempno);
            var xdown 	= _x.slice(tempno,_x.length+1);
            var newx 	= xdown.concat(xup);

            var yup 	= _y.slice(0,tempno);
            var ydown 	= _y.slice(tempno,_y.length+1);
            var newy 	= ydown.concat(yup);

            /*	Not used in this version
            for(var j=0; j<_tan.length-1; j++){
                _pm.push((_tan[j+1]-_tan[j])/(_x[j+2]-_x[j]));
            }
            */

            //var start;
            //var stop;
            var part	= [];
            var arrno	= 0;
            var countt	= 0;

            for(var j=1; j<newtan.length-1; j++){
                if(Math.abs(newtan[j])<0.2679){
                    if(countt==0){
                        var tt=[];
                        part.push(tt);
                        countt++;
                    }
                    part[arrno].push(j);
                }else{
                    if(countt!=0){
                        countt=0;
                        arrno++;
                    }
                }
            }

            var yval=[];

            for(var qq=0; qq<part.length; qq++){
                var ytemp=newy[part[qq][0]];
                for(var pp=1; pp<part[qq].length; pp++){
                    if(ytemp<newy[part[qq][pp]]){
                        ytemp=newy[part[qq][pp]];
                    }
                }
                yval.push(ytemp);
            }

            var minval		= Math.min.apply(null, yval);
            var minindex	= yval.indexOf(minval.toString());
            var lengthtemp	= 0.0;

            if(part[minindex]!=null){
                for(var c=0; c<part[minindex].length-1; c++){
                    var tempxx1	= newx[part[minindex][c]];
                    tempxx1*=1;
                
                    var tempxx2	= newx[part[minindex][c+1]];
                    tempxx2*=1;
                
                    var tempyy1 = newy[part[minindex][c]];
                    tempyy1*=1;
                
                    var tempyy2 = newy[part[minindex][c+1]];
                    tempyy2*=1;
                
                    var tempxx=(tempxx1-tempxx2);
                    //var tempyy=(tempyy1-tempyy2);
                    //var sum = (tempxx*tempxx)+(tempyy*tempyy);
                    //sum = Math.sqrt(sum);
                    lengthtemp+=tempxx;
                }
            }

            //======================== OUTPUT 1: Ground Length ===============================
            groundLength = Math.abs(lengthtemp); // groundLength = lengthtemp;
            //================================================================================
            
            var temp_angle=[];
            var angletemp=[];
            var temp_angleOut = 0;

            if(part[minindex]!=null){
                for(var d=0;d<part[minindex].length;d++){
                    var temp_angle1=newa[part[minindex][d]];
                    temp_angle1*=1;
                    temp_angle.push(temp_angle1);
                }
            }

            if(temp_angle.length>0){
                temp_angleOut=(temp_angle[temp_angle.length-1]-temp_angle[0]);
            
                if(temp_angleOut<0){
                    temp_angleOut+=2*Math.PI;
                }
            }
            var angletemp=temp_angleOut/(2*Math.PI);

            //==================== OUTPUT 2: Ground Angle Coefficient ========================
            groundAngleCo=angletemp;
            //================================================================================
            
            returnValue.push(groundLength);
            returnValue.push(groundAngleCo);
            
            return returnValue;
        }

        </script>
        
        <div class="msketch-panel-container" id="panel_opt" style="display: none">
        <div class="msketch-panel-title">Path<br>Optimization</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc">Optimize current mechanism's movement fitting to target drawing. Draw a movement that you want</div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc" id="panel_opt_msg" style="font-style: italic;"></div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Marker List" style="width: 100%;">
        <select id="panel_opt_markerIndex" class="form-select msketch-panel-select">
        </select>
        </div>
        </div>
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large" id="panel_opt_draw"><i class="material-icons">gesture</i>Draw Target Path</button>
        <button class="msketch-panel-btn-large" id="panel_opt_remove"><i class="material-icons">delete</i>Remove Target Path</button>
        </div>
        <hr>
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large disableClick" id="panel_opt_run"><i class="material-icons">done</i>Optimize</button>
        <button class="msketch-panel-btn-large disableClick" id="panel_opt_stop"><i class="material-icons">stop</i>Stop</button>
        </div>
        </div>
        
        <script>

            var baseTrjObject = null;
            var baseTrjInd = null;

        $('#panel_opt_run').click( function(){
            startPathOptimize();
        });

        $('#panel_opt_stop').click( function(){
            stopPathOptimize();
        });

        $('#panel_opt_draw').click( function(){
            if(toolState!=TOOL_OPT){
                toolState = TOOL_OPT;
            }
            else if(toolState==TOOL_OPT){
            toolState = -1;
            }
            setTool(toolState);
            checkToolSet();
        });

        $('#panel_opt_remove').click( function(){
            currentAssemblyGroup.optimizedPath.flush();
            currentAssemblyGroup.load();
        });

        $('#panel_opt_markerIndex').on('mousedown', function(){
            $('#panel_opt_markerIndex').empty();
            $.each(currentAssemblyGroup.trajectoryObjList, function (i, item) {
                $('#panel_opt_markerIndex').append($('<option>', {
                    value: i,
                    text : "Trajectory " + i
                }));
            });
            $('#panel_opt_markerIndex').val(null);
        });

        $('#panel_opt_markerIndex').on('change', function(){
            checkBaseTrj(true);
        });


        function checkBaseTrj(_flag){
        if($('#panel_opt_markerIndex').val()==null) return;

            baseTrjObject = currentAssemblyGroup.trajectoryObjList[parseInt( $('#panel_opt_markerIndex').val() )];
            baseTrjInd = parseInt( $('#panel_opt_markerIndex').val() );
        if(baseTrjObject==null) return;

            for(var i=0; i<currentAssemblyGroup.trajectoryObjList.length; i++){
                if(_flag && baseTrjObject == currentAssemblyGroup.trajectoryObjList[i]){
                    currentAssemblyGroup.trajectoryObjList[i].setColor(0x4bb7ba);
                }else{
                    currentAssemblyGroup.trajectoryObjList[i].setColor(0x6a3fc4);
                }
            }
        }

        function flushAllTargetTrj(){
            for(var i=0; i<AssemblyGroupList.length; i++){
                AssemblyGroupList[i].optimizedPath.flush();
            }
        }

        function startPathOptimize(){

        if(baseTrjObject == null || baseTrjInd == null){
            showMessage("No base trajectory to optimize.");
            return;
        }

        if(currentAssemblyGroup.optimizedPath.getTrajectory() == null){
            showMessage("No base trajectory to optimize.");
            return;
        }

        for(var i=0; i<AssemblyGroupList.length; i++){
            AssemblyGroupList[i].hideText();
        }

            currentInterface.ind = baseTrjInd;
            currentInterface.Lambda = 5;
            currentInterface.targetTrj = resample(currentAssemblyGroup.optimizedPath.getTrajectory(), OptInterface.SAMPLE_SIZE);
            currentInterface.total_iter = 0;
            currentInterface.accumTime = 0;
            isPathOptimizing = true;

        showMessage("Path optimization started.");
        }

        function stopPathOptimize(){
            if(isPathOptimizing) showMessage("Path optimization finished.");
            isPathOptimizing = false;
            //currentInterface.ind = -1;

            for(var i=0; i<AssemblyGroupList.length; i++){
                AssemblyGroupList[i].showText();
            }
        }

        function showOptMsg(_msg){
            $('#panel_opt_msg').text(_msg);
        }


        // === OPT CORE ===

        // for optimization
        function optimize() {
            if (currentInterface.ind==-1) return;
            
            var iter=0;
            var isBroken = false;
            var preAvgGrd = Number.POSITIVE_INFINITY;
            
            var Epsilon = 0.001;
            //var Epsilon = 0.0005;

            var TIME_OUT = 20;
            
            var targetTrj = currentInterface.targetTrj;
            var cost=getDistScore(currentInterface.ind, targetTrj);
            var prevCost=cost*2;
            var STOP_COST_RATIO = 0.0001;

            // Point2D[] targetTrj = resample(t.getTrajectory(), SAMPLE_SIZE);
            
            var currentTime = new Date().getTime();
        while ((currentTime+TIME_OUT > (new Date().getTime()) && !isBroken && prevCost>cost*STOP_COST_RATIO) || iter<2) {
            var pointBackup = new ArrayList();
            var pointMap = new Object();

            // calc gradient //
            prevCost = cost;
            for (var i=0, _length = currentAssembly.getAllElement().length(); i<_length; i++) {
                if (currentAssembly.getAllElement().get(i) instanceof Link ) { // && !(assembly.getAllElement().get(i) instanceof Space //
                    var l = currentAssembly.getAllElement().get(i);
                
                    for (var j=0, _linkLength = l.getPointList().length(); j<_linkLength; j++) {
                        var pt = l.getPointList().get(j);
                        var opt = new Point2D( pt.getX(), pt.getY() );
                        pointBackup.add(opt);
                    
                        pt.setLocation(opt.getX()-Epsilon, opt.getY());
                        var n_dist = getDistScore(currentInterface.ind, targetTrj);
                        pt.setLocation(opt.getX()+Epsilon, opt.getY());
                        var p_dist = getDistScore(currentInterface.ind, targetTrj);
                    
                        var deltaX = 0;
                        if (n_dist+p_dist < Number.POSITIVE_INFINITY) {
                            deltaX = (p_dist-n_dist)/2/Epsilon;
                        }
                    
                        pt.setLocation(opt.getX(), opt.getY()-Epsilon);
                        n_dist = getDistScore(currentInterface.ind, targetTrj);
                        pt.setLocation(opt.getX(), opt.getY()+Epsilon);
                        p_dist = getDistScore(currentInterface.ind, targetTrj);
                    
                        var deltaY = 0;
                        if (n_dist+p_dist < Number.POSITIVE_INFINITY) {
                            deltaY = (p_dist-n_dist)/2/Epsilon;
                        }
                    
                        pt.setLocation(opt.getX(), opt.getY());
                        
                        pointMap[l.name+","+j] = new Point2D(deltaX, deltaY);
                    
                        //pt.setLocation(opt.getX()-deltaX*currentInterface.Lambda, opt.getY()-deltaY*currentInterface.Lambda);
                    
                    }
                }
            }

            // apply decent //
            for (var i=0, _length = currentAssembly.getAllElement().length(); i<_length; i++) {
                if (currentAssembly.getAllElement().get(i) instanceof Link) { // && !(assembly.getAllElement().get(i) instanceof Space) ){
                    var l = currentAssembly.getAllElement().get(i);
                
                    for (var j=0, _linkLength = l.getPointList().length(); j<_linkLength; j++) {
                        var pt = l.getPointList().get(j);
                        var grd_pt = pointMap[l.name+","+j];
                        
                        if (grd_pt != null) {
                            pt.setLocation(pt.getX()-grd_pt.getX()*currentInterface.Lambda, pt.getY()-grd_pt.getY()*currentInterface.Lambda);
                        }
                    }
                }
            }

            cost = getDistScore(currentInterface.ind, targetTrj);
            if (cost > prevCost) currentInterface.Lambda *= 0.80;
        if ( cost == Number.POSITIVE_INFINITY) {
            //console.log("broken at #"+currentInterface.total_iter);
            isBroken = true;
            stopPathOptimize();
            showMessage("Broken at #"+currentInterface.total_iter);
            
            var cnt=0;
            for (var i=0, _length = currentAssembly.getAllElement().length(); i<_length; i++) {
                if (currentAssembly.getAllElement().get(i) instanceof Link  ) { // && !(assembly.getAllElement().get(i) instanceof Space //
                    var l = currentAssembly.getAllElement().get(i);
                
                    for (var j=0, _linkLength = l.getPointList().length(); j<_linkLength; j++) {
                        var pt = l.getPointList().get(j);
                        var opt = pointBackup.get(cnt++);
                    
                        if (opt!=null) {
                            pt.setLocation(opt.getX(), opt.getY());
                        }
                    }
                }
            }

            break;
            } else {
                pointBackup = new ArrayList();
                currentAssemblyGroup.calculateAssembly();
            }

            iter++;
            currentInterface.total_iter++;
            this.msg="Iteration: "+currentInterface.total_iter + " / Cost: " + Math.abs((prevCost/cost)-1).toFixed(6);
            //console.log("Iteration #"+currentInterface.total_iter + " / " + Math.abs((prevCost/cost)-1).toFixed(10));
            showOptMsg(this.msg);
        }

        for (var i=0, _length = currentAssembly.getAllElement().length(); i<_length; i++) {
            if (currentAssembly.getAllElement().get(i) instanceof Link && !(currentAssembly.getAllElement().get(i) instanceof Space) ) {
                var l = currentAssembly.getAllElement().get(i);
                l.redefineVertex();
            }
        }

        if ( isBroken || Math.abs((prevCost/cost).toFixed(10)-1) <= STOP_COST_RATIO ) {
            stopPathOptimize();
        }

        //render
        if(currentInterface.total_iter%2==0){
            //render();
        }
            //render();
        }

        function resample(pts, number){
            var I = pathLength( pts ) / (number-1);
            var D = 0;
            
            var returns = new Array(number);
            
            returns[0] = new Point2D( pts.get(0).getX(), pts.get(0).getY() );
            var cnt = 1;

        for ( var idx=1, _length = pts.length(); idx<_length; idx++ ) {
            var d = dist2D(pts.get(idx-1).getX(), pts.get(idx-1).getY(), pts.get(idx).getX(), pts.get(idx).getY());
            if ( D+d >= I ) {
                var qx = pts.get(idx-1).getX() + ((I-D) / d) * (pts.get(idx).getX() - pts.get(idx-1).getX() );
                var qy = pts.get(idx-1).getY() + ((I-D) / d) * (pts.get(idx).getY() - pts.get(idx-1).getY() );
            
                if (cnt<number) {
                    returns[cnt++] = new Point2D( qx, qy );
                }
                pts.set(idx-1, new Point2D( qx, qy ));
                idx--;
                D = 0;
            } else {
                D += d;
            }
        }

        while ( cnt < number ) {
            returns[cnt++] = pts.get(pts.length()-1);
        }

            return returns;
        }

        function pathLength(pts) {
            var totalLen = 0;
            for (var i=0, _length = pts.length(); i<_length-1; i++) {
                totalLen += dist2D( pts.get(i).getX(), pts.get(i).getY(), pts.get(i+1).getX(), pts.get(i+1).getY() );
            }
            return totalLen;
        }

        function dist2D(x1, y1, x2, y2) {
            var dx = x1-x2;
            var dy = y1-y2;
            return Math.sqrt(dx*dx + dy*dy);
        }

        function getDistScore(resultInd, targetTrjSample) {

            var cost = currentAssemblyGroup.try360();

            if ( cost < Number.POSITIVE_INFINITY) {
                var selectedTrj = currentAssemblyGroup.getTrajectory().get(resultInd).getTrajectory();
                var resultTrj = resample(selectedTrj, OptInterface.SAMPLE_SIZE);
                return compareTrj(targetTrjSample, resultTrj)+cost;
            } else {
                return Number.POSITIVE_INFINITY;
            }
        }

        function compareTrj(t1, t2) {
            var totalLen = 0;
            for (var i=0, _length = t1.length; i<_length; i++) {
                totalLen += dist2D(t1[i].getX(), t1[i].getY(), t2[i].getX(), t2[i].getY());
            }
                return totalLen/OptInterface.SAMPLE_SIZE;
            }


        </script>
        
        <!-- Linkage generation panel
        made by yunwoo jeong -->
        <!-- yw_edited -->
        
        <div class="msketch-panel-container" id="panel_gen" style="display: none">
        <div class="msketch-panel-title">Linkage<br>Generation</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc">Generate the linkage mechanism. Draw a movement that you want</div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc" id="panel_gen_msg" style="font-style: italic;"></div>
        </div>
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large" id="panel_gen_draw"><i class="material-icons">gesture</i>Draw Target Path</button>
        <button class="msketch-panel-btn-large" id="panel_gen_remove"><i class="material-icons">delete</i>Remove Target Path</button>
        </div>
        <hr>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Mechanism Type" style="width: 100%;">
        <label class="form-radio" style="width: 49%;">
        <input type="radio" name="gender" id="panel_gen_4" checked>
        <i class="form-icon"></i> <span class="msketch-panel-desc">4-bar</span>
        </label>
        <label class="form-radio" style="width: 49%;">
        <input type="radio" name="gender" id="panel_gen_6" >
        <i class="form-icon"></i> <span class="msketch-panel-desc">6-bar</span>
        </label>
        </div>
        </div>
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large" id="panel_gen_run"><i class="material-icons">done</i>Generate</button>
        </div>
        </div>
        
        <script>

        $('#panel_gen_draw').click( function(){
            if(toolState!=TOOL_OPT){
                toolState = TOOL_OPT;
            }
            else if(toolState==TOOL_OPT){
                toolState = -1;
            }
            setTool(toolState);
            checkToolSet();
        });

        $('#panel_gen_remove').click( function(){
            currentAssemblyGroup.optimizedPath.flush();
            currentAssemblyGroup.load();
        });

        $('#panel_gen_run').click( function(){
            if( $('#panel_gen_4').prop('checked') ){
                var t0 = performance.now();
                startFourbarGeneration();
                var t1 = performance.now();
                console.log("Call to startFourbarGeneration took " + (t1 - t0) + " milliseconds.")
            }
            else if( $('#panel_gen_6').prop('checked') ){
                 var t0 = performance.now();
                 startWattGeneration();
                 var t1 = performance.now();
                 console.log("Call to startFourbarGeneration took " + (t1 - t0) + " milliseconds.")
             }
        });

            //var wattDataPath = "./public/res/WattDataSet";
            var wattDataPath = "./public/res/WattDataSet";
            //var fourbarDataPath = "./public/res/FourbarDataSet";
            var fourbarDataPath = "./public/res/FourbarDataSet";
            var WEIGHT_DIST = 10;
            var WEIGHT_ANGLE = 0.1;
            var WATT_SAMPLE_SIZE = 16;
            var FOURBAR_SAMPLE_SIZE = 16;
            var NUM_OF_WATT_DATASET = 5;
            var NUM_OF_FOURBAR_DATASET = 1;
            var sampleWattTrj = loadWattSet();
            var sampleFourbarTrj = loadFourbarSet();

        function startWattGeneration(){
            var targetPathData = currentAssemblyGroup.optimizedPath.getTrajectory();
            try360forAssemblies();
            var _sampleSize = WATT_SAMPLE_SIZE;
            var tempTrj = [];
            if(currentAssemblyGroup.optimizedPath.getTrajectory() == null){
                showSnackBar("No target trajectory to optimize", "No target trajectory to optimize");
                return;
            }
            var positionTrj = resample(currentAssemblyGroup.optimizedPath.getTrajectory(), _sampleSize);
            _trjData = normalizeTrj(positionTrj);
            tempTrj = _trjData.trajectory;
            
            getSimilarWatt(tempTrj, sampleWattTrj, targetPathData);

            //get optimized path
            currentAssemblyGroup.optimizedPath = new Trajectory();
            currentAssemblyGroup.optimizedPath.flush();

            for(var i in targetPathData.array){
                var a =targetPathData.get(i)
                currentAssemblyGroup.optimizedPath.getTrajectory().add(a);
                currentAssemblyGroup.load();
            }
        }

        function startFourbarGeneration(){
            var targetPathData = currentAssemblyGroup.optimizedPath.getTrajectory();
            try360forAssemblies();
            var _sampleSize = FOURBAR_SAMPLE_SIZE;
            var tempTrj = [];
        if(currentAssemblyGroup.optimizedPath.getTrajectory() == null){
            showSnackBar("No target trajectory to optimize", "No target trajectory to optimize");
            return;
        }

            var positionTrj = resample(currentAssemblyGroup.optimizedPath.getTrajectory(), _sampleSize);
            _trjData = normalizeTrj(positionTrj);
            tempTrj = _trjData.trajectory;

            getSimilarFourbar(tempTrj, sampleFourbarTrj, targetPathData);

            //get optimized path
            currentAssemblyGroup.optimizedPath = new Trajectory();
            currentAssemblyGroup.optimizedPath.flush();

            for(var i in targetPathData.array){
                var a =targetPathData.get(i)
                currentAssemblyGroup.optimizedPath.getTrajectory().add(a);
                currentAssemblyGroup.load();
            }
        }

        function loadWattSet(){
            var _returnData = [];
            for(var j=0; j<NUM_OF_WATT_DATASET; j++){
                xmlhttp = new XMLHttpRequest();
                xmlhttp.open("GET", wattDataPath+"_"+j+".txt" ,false);
                xmlhttp.send(null);
                var _data = xmlhttp.responseText;
                // original for windows
                // var _lineData = _data.split("\r\n");
                var _lineData = _data.split("\n");
                for(i=0; i<_lineData.length; i++){
                    if(_lineData[i]!="") _returnData.push(JSON.parse(_lineData[i]));
                }
            }
            console.log("Loaded: " + _returnData.length);
            return _returnData;
        }

        function loadFourbarSet(){
            var _returnData = [];
        for(var j=0; j<NUM_OF_FOURBAR_DATASET; j++){
            xmlhttp = new XMLHttpRequest();
            //xmlhttp.open("GET", fourbarDataPath+"_"+j+".txt" ,false);
            xmlhttp.open("GET", fourbarDataPath+"_"+j+".txt", false);
            xmlhttp.send(null);
            var _data = xmlhttp.responseText;
            // original for windows
            //var _lineData = _data.split("\r\n");
            var _lineData = _data.split("\n");
            for(i=0; i<_lineData.length; i++){
                if(_lineData[i]!="") _returnData.push(JSON.parse(_lineData[i]));
            }
        }
            console.log("Loaded: " + _returnData.length);
            return _returnData;
        }


        function loadJSON(_dataJSON, _isNew){
            //check header
            if(_dataJSON.app != "EDISON" || _dataJSON.type != "Assembly"){
                showMessage("Wrong File");
                return null;
            }else{
                makeNewFile();
            }
            // generate planes
            for(var i=0; i<_dataJSON.sketches.length; i++){
                loadMsketchInfoForPlane(_dataJSON.sketches[i], _isNew)
            }
            try360forAssemblies();
            updateMotorList();
            removeAssemblyGroup(0);
        }

        function getSimilarWatt(_trjArr, _dataset, _targetTrj){
            var _lowestDist = Number.POSITIVE_INFINITY;
            var _targetPoints = null;

            for(var i in _dataset){
                var dtwTrj = new DynamicTimeWarping(reOrderArray(_trjArr), reOrderArray(_dataset[i].trajectory), distFuncTrj);
                var distTrj = dtwTrj.getDistance()/(dtwTrj.getPath().length);
                
                var distAngle = 0
            
                var _totalDist = WEIGHT_DIST * distTrj + WEIGHT_ANGLE * distAngle/(2*Math.PI); // weight
                if(_totalDist < _lowestDist){
                    _lowestDist = _totalDist;
                    _targetPoints = _dataset[i].points;
                    _dir = _dataset[i].dir;
                    _targetTrajectory = _dataset[i].trajectory
                    console.log("[Calc] DistTRJ: " + distTrj + " / DistAngle: " + distAngle);
                }
            }
            console.log("LowestDist: " + _lowestDist);
            drawWatt(_targetPoints, _dir, 0, 0);

            //set trj poistion and motor phase
            //set motor phase
            var _optTrj = currentAssemblyGroup.getTrajectory().get(0).getTrajectory();
            var _centerTargetTrj = findCenterPosition(_targetTrj);
            var _centerOptTrj = findCenterPosition(_optTrj);

            var _ftX = _targetTrj.get(0).x *0.1;
            var _ftY = _targetTrj.get(0).y *0.1;
            var _targetPathFirstPointAngle = Math.atan2((_ftY-_centerTargetTrj.y*0.1),(_ftX-_centerTargetTrj.x*0.1));
            if(_targetPathFirstPointAngle<0){
                _targetPathFirstPointAngle = 2*Math.PI + _targetPathFirstPointAngle;
            }

            var _foX = _optTrj.get(0).x *0.1;
            var _foY = _optTrj.get(0).y *0.1;
            var _optPathFirstPointAngle = Math.atan2((_foY-_centerOptTrj.y*0.1),(_foX-_centerOptTrj.x*0.1));
            if(_optPathFirstPointAngle<0){
                _optPathFirstPointAngle = 2*Math.PI + _optPathFirstPointAngle;
            }

            var _motorPhase = (_optPathFirstPointAngle-_targetPathFirstPointAngle)*180/Math.PI;
            if(_motorPhase <0){
                _motorPhase = 360 + _motorPhase;
            }

            //move trj
            var _dx = (_centerTargetTrj.x - _centerOptTrj.x) * 0.1;
            var _dy = (_centerTargetTrj.y - _centerOptTrj.y) * 0.1;
            
            for(i=0; i<_targetPoints.length; i++){
                _targetPoints[i].x += _dx;
                _targetPoints[i].y += _dy;
            }

            //scale trj
            var _ratio = (findMaxY(_targetTrj)-findMinY(_targetTrj))/(findMaxY(_optTrj)-findMinY(_optTrj));
            for(var i=0; i<_targetPoints.length; i++){
                _targetPoints[i] = scaleFromPoint(_targetPoints[i], _ratio, _centerTargetTrj.x * 0.1, _centerTargetTrj.y * 0.1);
            }

            drawWatt(_targetPoints, _dir, 0, _motorPhase);
        }

        function getSimilarFourbar(_trjArr, _dataset, _targetTrj){
            var _lowestDist = Number.POSITIVE_INFINITY;
            var _targetPoints = null;

            for(var i in _dataset){
                var dtwTrj = new DynamicTimeWarping(reOrderArray(_trjArr), reOrderArray(_dataset[i].trajectory), distFuncTrj);
                var distTrj = dtwTrj.getDistance()/(dtwTrj.getPath().length);
                
                var distAngle = 0
            
                var _totalDist = WEIGHT_DIST * distTrj + WEIGHT_ANGLE * distAngle/(2*Math.PI); // weight
                if(_totalDist < _lowestDist){
                    _lowestDist = _totalDist;
                    _targetPoints = _dataset[i].points;
                    _dir = _dataset[i].dir;
                    _targetTrajectory = _dataset[i].trajectory
                    console.log("[Calc] DistTRJ: " + distTrj + " / DistAngle: " + distAngle);
                }
            }
            console.log("LowestDist: " + _lowestDist);
            drawFourbar(_targetPoints, _dir, 0, 0);
            
            //set trj poistion and motor phase
            //set motor phase
            var _optTrj = currentAssemblyGroup.getTrajectory().get(0).getTrajectory();
            var _centerTargetTrj = findCenterPosition(_targetTrj);
            var _centerOptTrj = findCenterPosition(_optTrj);

            var _ftX = _targetTrj.get(0).x *0.1;
            var _ftY = _targetTrj.get(0).y *0.1;
            var _targetPathFirstPointAngle = Math.atan2((_ftY-_centerTargetTrj.y*0.1),(_ftX-_centerTargetTrj.x*0.1));
            if(_targetPathFirstPointAngle<0){
                _targetPathFirstPointAngle = 2*Math.PI + _targetPathFirstPointAngle;
            }

            var _foX = _optTrj.get(0).x *0.1;
            var _foY = _optTrj.get(0).y *0.1;
            var _optPathFirstPointAngle = Math.atan2((_foY-_centerOptTrj.y*0.1),(_foX-_centerOptTrj.x*0.1));
            if(_optPathFirstPointAngle<0){
                _optPathFirstPointAngle = 2*Math.PI + _optPathFirstPointAngle;
            }

            var _motorPhase = (_optPathFirstPointAngle-_targetPathFirstPointAngle)*180/Math.PI;
            if(_motorPhase <0){
                _motorPhase = 360 + _motorPhase;
            }

            //move trj
            var _dx = (_centerTargetTrj.x - _centerOptTrj.x) * 0.1;
            var _dy = (_centerTargetTrj.y - _centerOptTrj.y) * 0.1;

            for(i=0; i<_targetPoints.length; i++){
                _targetPoints[i].x += _dx;
                _targetPoints[i].y += _dy;
            }

            //scale trj
            var _ratio = (findMaxY(_targetTrj)-findMinY(_targetTrj))/(findMaxY(_optTrj)-findMinY(_optTrj));
            for(var i=0; i<_targetPoints.length; i++){
                _targetPoints[i] = scaleFromPoint(_targetPoints[i], _ratio, _centerTargetTrj.x * 0.1, _centerTargetTrj.y * 0.1);
            }

            drawFourbar(_targetPoints, _dir, 0, _motorPhase);
        }

        function scaleFromPoint(_p, _ratio, _x, _y){ // (_p{x: , y: }, ratio, x, y)
            var _qx = _p.x - (_p.x-_x)*(1-_ratio);
            var _qy = _p.y - (_p.y-_y)*(1-_ratio);
            return {x: _qx, y: _qy};
        }

        function findMaxY(_trj){  //find maximum y value of trj point
            var _yMax = Number.NEGATIVE_INFINITY;
            for(var i in _trj.array){
                if(_trj.get(i).y > _yMax){
                    _yMax = _trj.get(i).y;
                }
            }
            return _yMax;
        }

        function findMinY(_trj){ //find minimum y value of trj point
            var _yMin = Number.POSITIVE_INFINITY;
            for(var i in _trj.array){
                if(_trj.get(i).y < _yMin){
                    _yMin = _trj.get(i).y;
                }
            }
            return _yMin;
        }

        function drawWatt(_parr, _dir, _angle, _motorPhase){

            var tempWattObject = {"app":"EDISON","type":"Assembly","fileVersion":"2.0","description":"Saved From M.Sketch v3.0","sketches":[{"plane":{"name":"Plane0","translation":{"x":"0.00","y":"0.00","z":"0.00"},"rotation":{"x":"0.00","y":"0.00","z":"0.00"}},"anchor":{"points":[{"x":"0.00","y":"0.00","z":"0.00"},{"x":"100.00","y":"0.00","z":"0.00"}]},"links":[{"name":"Crank","points":[{"x":"0.00","y":"0.00","z":"0.00"},{"x":"0.00","y":"40.00","z":"0.00"}]},{"name":"Rocker","points":[{"x":"100.00","y":"0.00","z":"0.00"},{"x":"100.00","y":"50.00","z":"0.00"},{"x":"100.00","y":"25.00","z":"0.00"}]},{"name":"Coupler1","points":[{"x":"0.00","y":"40.00","z":"0.00"},{"x":"100.00","y":"50.00","z":"0.00"}]},{"name":"Coupler2","points":[{"x":"-0.00","y":"40.00","z":"0.00"},{"x":"35.86","y":"74.96","z":"0.00"}]},{"name":"Coupler3","points":[{"x":"35.86","y":"74.96","z":"0.00"},{"x":"100.00","y":"50.00","z":"0.00"}]},{"name":"WattCoupler","points":[{"x":"100.00","y":"25.00","z":"0.00"},{"x":"132.75","y":"109.40","z":"0.00"}]},{"name":"TargetLink","points":[{"x":"132.75","y":"109.40","z":"0.00"},{"x":"35.86","y":"74.96","z":"0.00"},{"x":"85.27","y":"92.72","z":"0.00"}]}],"constraints":[{"name":"CoaxialConstraint1","points":[{"targetLink":"Crank","targetIndex":0},{"targetLink":"Anchor","targetIndex":0}]},{"name":"CoaxialConstraint2","points":[{"targetLink":"Rocker","targetIndex":0},{"targetLink":"Anchor","targetIndex":1}]},{"name":"CoaxialConstraint3","points":[{"targetLink":"Coupler2","targetIndex":0},{"targetLink":"Crank","targetIndex":1},{"targetLink":"Coupler1","targetIndex":0}]},{"name":"CoaxialConstraint4","points":[{"targetLink":"Rocker","targetIndex":1},{"targetLink":"Coupler3","targetIndex":1},{"targetLink":"Coupler1","targetIndex":1}]},{"name":"CoaxialConstraint5","points":[{"targetLink":"WattCoupler","targetIndex":0},{"targetLink":"Rocker","targetIndex":2}]},{"name":"CoaxialConstraint6","points":[{"targetLink":"TargetLink","targetIndex":0},{"targetLink":"WattCoupler","targetIndex":1}]},{"name":"CoaxialConstraint7","points":[{"targetLink":"Coupler2","targetIndex":1},{"targetLink":"TargetLink","targetIndex":1},{"targetLink":"Coupler3","targetIndex":0}]}],"sliders":[],"markers":[{"targetLink":"TargetLink","targetIndex":2}],"motors":[{"name":"Motor1","targetConstraint":"CoaxialConstraint1","targetLink1":"Crank","targetLink2":"Anchor","type":"DC","direction":0,"speed":100,"phase":0,"range":"0-180"}]}]}
            
            //anchor
            tempWattObject.sketches[0].anchor.points[0].x = _parr[0].x; //a1
            tempWattObject.sketches[0].anchor.points[0].y = _parr[0].y;
            tempWattObject.sketches[0].anchor.points[1].x = _parr[1].x; //a2
            tempWattObject.sketches[0].anchor.points[1].y = _parr[1].y;
            
            //crank
            tempWattObject.sketches[0].links[0].points[0].x = _parr[0].x; //a1
            tempWattObject.sketches[0].links[0].points[0].y = _parr[0].y;
            tempWattObject.sketches[0].links[0].points[1].x = _parr[2].x; //a2
            tempWattObject.sketches[0].links[0].points[1].y = _parr[2].y;
            
            //Rocker
            tempWattObject.sketches[0].links[1].points[0].x = _parr[1].x; //a1
            tempWattObject.sketches[0].links[1].points[0].y = _parr[1].y;
            tempWattObject.sketches[0].links[1].points[1].x = _parr[3].x; //a2
            tempWattObject.sketches[0].links[1].points[1].y = _parr[3].y;
            tempWattObject.sketches[0].links[1].points[2].x = _parr[5].x; //a2
            tempWattObject.sketches[0].links[1].points[2].y = _parr[5].y;
            
            //Coupler1
            tempWattObject.sketches[0].links[2].points[0].x = _parr[2].x; //p1
            tempWattObject.sketches[0].links[2].points[0].y = _parr[2].y;
            tempWattObject.sketches[0].links[2].points[1].x = _parr[3].x; //p2
            tempWattObject.sketches[0].links[2].points[1].y = _parr[3].y;
            
            //Coupler2
            tempWattObject.sketches[0].links[3].points[0].x = _parr[2].x; //p1
            tempWattObject.sketches[0].links[3].points[0].y = _parr[2].y;
            tempWattObject.sketches[0].links[3].points[1].x = _parr[4].x; //p3
            tempWattObject.sketches[0].links[3].points[1].y = _parr[4].y;
            
            //Coupler3
            tempWattObject.sketches[0].links[4].points[0].x = _parr[4].x; //p3
            tempWattObject.sketches[0].links[4].points[0].y = _parr[4].y;
            tempWattObject.sketches[0].links[4].points[1].x = _parr[3].x; //p2
            tempWattObject.sketches[0].links[4].points[1].y = _parr[3].y;
            
            //WattCoupler
            tempWattObject.sketches[0].links[5].points[0].x = _parr[5].x; //c1
            tempWattObject.sketches[0].links[5].points[0].y = _parr[5].y;
            tempWattObject.sketches[0].links[5].points[1].x = _parr[6].x; //c2
            tempWattObject.sketches[0].links[5].points[1].y = _parr[6].y;
            
            //TargetLink
            var _target_center_x = (_parr[4].x + _parr[6].x)/2;
            var _target_center_y = (_parr[4].y + _parr[6].y)/2;
            tempWattObject.sketches[0].links[6].points[0].x = _parr[6].x; //c2
            tempWattObject.sketches[0].links[6].points[0].y = _parr[6].y;
            tempWattObject.sketches[0].links[6].points[1].x = _parr[4].x; //p3
            tempWattObject.sketches[0].links[6].points[1].y = _parr[4].y;
            tempWattObject.sketches[0].links[6].points[2].x = _target_center_x; //(c2+p3)/2
            tempWattObject.sketches[0].links[6].points[2].y = _target_center_y;
            
            tempWattObject.sketches[0].motors[0].phase = _motorPhase;
            tempWattObject.sketches[0].motors[0].direction = _dir;
            
            loadJSON(tempWattObject, true);
        }

        /////drawWatt function for generateWatt
        function drawWatt_generate(_parr, _dir, _angle, _motorPhase){

            var tempWattObject = {"app":"EDISON","type":"Assembly","fileVersion":"2.0","description":"Saved From M.Sketch v3.0","sketches":[{"plane":{"name":"Plane0","translation":{"x":"0.00","y":"0.00","z":"0.00"},"rotation":{"x":"0.00","y":"0.00","z":"0.00"}},"anchor":{"points":[{"x":"0.00","y":"0.00","z":"0.00"},{"x":"100.00","y":"0.00","z":"0.00"}]},"links":[{"name":"Crank","points":[{"x":"0.00","y":"0.00","z":"0.00"},{"x":"0.00","y":"40.00","z":"0.00"}]},{"name":"Rocker","points":[{"x":"100.00","y":"0.00","z":"0.00"},{"x":"100.00","y":"50.00","z":"0.00"},{"x":"100.00","y":"25.00","z":"0.00"}]},{"name":"Coupler1","points":[{"x":"0.00","y":"40.00","z":"0.00"},{"x":"100.00","y":"50.00","z":"0.00"}]},{"name":"Coupler2","points":[{"x":"-0.00","y":"40.00","z":"0.00"},{"x":"35.86","y":"74.96","z":"0.00"}]},{"name":"Coupler3","points":[{"x":"35.86","y":"74.96","z":"0.00"},{"x":"100.00","y":"50.00","z":"0.00"}]},{"name":"WattCoupler","points":[{"x":"100.00","y":"25.00","z":"0.00"},{"x":"132.75","y":"109.40","z":"0.00"}]},{"name":"TargetLink","points":[{"x":"132.75","y":"109.40","z":"0.00"},{"x":"35.86","y":"74.96","z":"0.00"},{"x":"85.27","y":"92.72","z":"0.00"}]}],"constraints":[{"name":"CoaxialConstraint1","points":[{"targetLink":"Crank","targetIndex":0},{"targetLink":"Anchor","targetIndex":0}]},{"name":"CoaxialConstraint2","points":[{"targetLink":"Rocker","targetIndex":0},{"targetLink":"Anchor","targetIndex":1}]},{"name":"CoaxialConstraint3","points":[{"targetLink":"Coupler2","targetIndex":0},{"targetLink":"Crank","targetIndex":1},{"targetLink":"Coupler1","targetIndex":0}]},{"name":"CoaxialConstraint4","points":[{"targetLink":"Rocker","targetIndex":1},{"targetLink":"Coupler3","targetIndex":1},{"targetLink":"Coupler1","targetIndex":1}]},{"name":"CoaxialConstraint5","points":[{"targetLink":"WattCoupler","targetIndex":0},{"targetLink":"Rocker","targetIndex":2}]},{"name":"CoaxialConstraint6","points":[{"targetLink":"TargetLink","targetIndex":0},{"targetLink":"WattCoupler","targetIndex":1}]},{"name":"CoaxialConstraint7","points":[{"targetLink":"Coupler2","targetIndex":1},{"targetLink":"TargetLink","targetIndex":1},{"targetLink":"Coupler3","targetIndex":0}]}],"sliders":[],"markers":[{"targetLink":"Coupler2","targetIndex":1},{"targetLink":"TargetLink","targetIndex":2},{"targetLink":"WattCoupler","targetIndex":1}],"motors":[{"name":"Motor1","targetConstraint":"CoaxialConstraint1","targetLink1":"Crank","targetLink2":"Anchor","type":"DC","direction":0,"speed":100,"phase":0,"range":"0-180"}]}]}
            
            
            //anchor
            tempWattObject.sketches[0].anchor.points[0].x = _parr[0].x; //a1
            tempWattObject.sketches[0].anchor.points[0].y = _parr[0].y;
            tempWattObject.sketches[0].anchor.points[1].x = _parr[1].x; //a2
            tempWattObject.sketches[0].anchor.points[1].y = _parr[1].y;
            
            //crank
            tempWattObject.sketches[0].links[0].points[0].x = _parr[0].x; //a1
            tempWattObject.sketches[0].links[0].points[0].y = _parr[0].y;
            tempWattObject.sketches[0].links[0].points[1].x = _parr[2].x; //a2
            tempWattObject.sketches[0].links[0].points[1].y = _parr[2].y;
            
            //Rocker
            tempWattObject.sketches[0].links[1].points[0].x = _parr[1].x; //a1
            tempWattObject.sketches[0].links[1].points[0].y = _parr[1].y;
            tempWattObject.sketches[0].links[1].points[1].x = _parr[3].x; //a2
            tempWattObject.sketches[0].links[1].points[1].y = _parr[3].y;
            tempWattObject.sketches[0].links[1].points[2].x = _parr[5].x; //a2
            tempWattObject.sketches[0].links[1].points[2].y = _parr[5].y;
            
            //Coupler1
            tempWattObject.sketches[0].links[2].points[0].x = _parr[2].x; //p1
            tempWattObject.sketches[0].links[2].points[0].y = _parr[2].y;
            tempWattObject.sketches[0].links[2].points[1].x = _parr[3].x; //p2
            tempWattObject.sketches[0].links[2].points[1].y = _parr[3].y;
            
            //Coupler2
            tempWattObject.sketches[0].links[3].points[0].x = _parr[2].x; //p1
            tempWattObject.sketches[0].links[3].points[0].y = _parr[2].y;
            tempWattObject.sketches[0].links[3].points[1].x = _parr[4].x; //p3
            tempWattObject.sketches[0].links[3].points[1].y = _parr[4].y;
            
            //Coupler3
            tempWattObject.sketches[0].links[4].points[0].x = _parr[4].x; //p3
            tempWattObject.sketches[0].links[4].points[0].y = _parr[4].y;
            tempWattObject.sketches[0].links[4].points[1].x = _parr[3].x; //p2
            tempWattObject.sketches[0].links[4].points[1].y = _parr[3].y;
            
            //WattCoupler
            tempWattObject.sketches[0].links[5].points[0].x = _parr[5].x; //c1
            tempWattObject.sketches[0].links[5].points[0].y = _parr[5].y;
            tempWattObject.sketches[0].links[5].points[1].x = _parr[6].x; //c2
            tempWattObject.sketches[0].links[5].points[1].y = _parr[6].y;
            
            //TargetLink
            var _target_center_x = (_parr[4].x + _parr[6].x)/2;
            var _target_center_y = (_parr[4].y + _parr[6].y)/2;
            tempWattObject.sketches[0].links[6].points[0].x = _parr[6].x; //c2
            tempWattObject.sketches[0].links[6].points[0].y = _parr[6].y;
            tempWattObject.sketches[0].links[6].points[1].x = _parr[4].x; //p3
            tempWattObject.sketches[0].links[6].points[1].y = _parr[4].y;
            tempWattObject.sketches[0].links[6].points[2].x = _target_center_x; //(c2+p3)/2
            tempWattObject.sketches[0].links[6].points[2].y = _target_center_y;
            
            tempWattObject.sketches[0].motors[0].phase = _motorPhase;
            tempWattObject.sketches[0].motors[0].direction = _dir;
            
            loadJSON(tempWattObject, true);
        }

        function drawFourbar(_parr, _dir, _angle, _motorPhase){
            var tempFourbarObject = {"app":"EDISON","type":"Assembly","fileVersion":"2.0","description":"Saved From M.Sketch v3.0","sketches":[{"plane":{"name":"Plane0","translation":{"x":"0.00","y":"0.00","z":"0.00"},"rotation":{"x":"0.00","y":"0.00","z":"0.00"}},"anchor":{"points":[{"x":"0.00","y":"0.00","z":"0.00"},{"x":"50.00","y":"0.00","z":"0.00"}]},"links":[{"name":"Crank","points":[{"x":"0.00","y":"0.00","z":"0.00"},{"x":"0.00","y":"25.00","z":"0.00"}]},{"name":"Rocker","points":[{"x":"50.00","y":"0.00","z":"0.00"},{"x":"50.00","y":"50.00","z":"0.00"}]},{"name":"Coupler1","points":[{"x":"0.00","y":"25.00","z":"0.00"},{"x":"50.00","y":"50.00","z":"0.00"}]},{"name":"Coupler2","points":[{"x":"-0.00","y":"25.00","z":"0.00"},{"x":"-0.00","y":"50.00","z":"0.00"}]},{"name":"Coupler3","points":[{"x":"-0.00","y":"50.00","z":"0.00"},{"x":"50.00","y":"50.00","z":"0.00"}]}],"constraints":[{"name":"CoaxialConstraint1","points":[{"targetLink":"Crank","targetIndex":0},{"targetLink":"Anchor","targetIndex":0}]},{"name":"CoaxialConstraint2","points":[{"targetLink":"Rocker","targetIndex":0},{"targetLink":"Anchor","targetIndex":1}]},{"name":"CoaxialConstraint5","points":[{"targetLink":"Coupler2","targetIndex":0},{"targetLink":"Crank","targetIndex":1},{"targetLink":"Coupler1","targetIndex":0}]},{"name":"CoaxialConstraint6","points":[{"targetLink":"Coupler3","targetIndex":0},{"targetLink":"Coupler2","targetIndex":1}]},{"name":"CoaxialConstraint7","points":[{"targetLink":"Rocker","targetIndex":1},{"targetLink":"Coupler3","targetIndex":1},{"targetLink":"Coupler1","targetIndex":1}]}],"sliders":[],"markers":[{"targetLink":"Coupler2","targetIndex":1}],"motors":[{"name":"Motor1","targetConstraint":"CoaxialConstraint1","targetLink1":"Crank","targetLink2":"Anchor","type":"DC","direction":0,"speed":100,"phase":0,"range":"0-180"}]}]}
            //anchor
            tempFourbarObject.sketches[0].anchor.points[0].x = _parr[0].x; //a1
            tempFourbarObject.sketches[0].anchor.points[0].y = _parr[0].y;
            tempFourbarObject.sketches[0].anchor.points[1].x = _parr[1].x; //a2
            tempFourbarObject.sketches[0].anchor.points[1].y = _parr[1].y;
            
            //crank
            tempFourbarObject.sketches[0].links[0].points[0].x = _parr[0].x; //a1
            tempFourbarObject.sketches[0].links[0].points[0].y = _parr[0].y;
            tempFourbarObject.sketches[0].links[0].points[1].x = _parr[2].x; //a2
            tempFourbarObject.sketches[0].links[0].points[1].y = _parr[2].y;
            
            //Rocker
            tempFourbarObject.sketches[0].links[1].points[0].x = _parr[1].x; //a1
            tempFourbarObject.sketches[0].links[1].points[0].y = _parr[1].y;
            tempFourbarObject.sketches[0].links[1].points[1].x = _parr[3].x; //a2
            tempFourbarObject.sketches[0].links[1].points[1].y = _parr[3].y;
            
            //Coupler1
            tempFourbarObject.sketches[0].links[2].points[0].x = _parr[2].x; //p1
            tempFourbarObject.sketches[0].links[2].points[0].y = _parr[2].y;
            tempFourbarObject.sketches[0].links[2].points[1].x = _parr[3].x; //p2
            tempFourbarObject.sketches[0].links[2].points[1].y = _parr[3].y;
            
            //Coupler2
            tempFourbarObject.sketches[0].links[3].points[0].x = _parr[2].x; //p1
            tempFourbarObject.sketches[0].links[3].points[0].y = _parr[2].y;
            tempFourbarObject.sketches[0].links[3].points[1].x = _parr[4].x; //p3
            tempFourbarObject.sketches[0].links[3].points[1].y = _parr[4].y;
            
            //Coupler3
            tempFourbarObject.sketches[0].links[4].points[0].x = _parr[4].x; //p3
            tempFourbarObject.sketches[0].links[4].points[0].y = _parr[4].y;
            tempFourbarObject.sketches[0].links[4].points[1].x = _parr[3].x; //p2
            tempFourbarObject.sketches[0].links[4].points[1].y = _parr[3].y;
            
            tempFourbarObject.sketches[0].motors[0].phase = _motorPhase;
            tempFourbarObject.sketches[0].motors[0].direction = _dir;
            
            loadJSON(tempFourbarObject, true);
        }

        function getTrj(){
            try360forAssemblies();
            var _sampleSize = WATT_SAMPLE_SIZE;

            if(currentAssemblyGroup.optimizedPath.getTrajectory() == null){
                showSnackBar("최적화 목적 궤적 없음", "No target trajectory to optimize");
                return;
            }

            //var positionTrj = resample(currentAssemblyGroup.getTrajectory().get(0).getTrajectory(), _sampleSize); // base position
            var positionTrj = resample(currentAssemblyGroup.optimizedPath.getTrajectory(), _sampleSize); // base position
            _trjData = normalizeTrj(positionTrj);
            tempTrj = _trjData.trajectory;
            
            console.log(JSON.stringify(tempTrj));
        }

        function findCenterPosition(_trj){
            var _xMean = 0;
            var _yMean = 0;

            for (var i in _trj.array){
                _xMean = _xMean + _trj.get(i).x;
                _yMean = _yMean + _trj.get(i).y;
            }
            _xMean = _xMean / _trj.length();
            _yMean = _yMean / _trj.length();
            
            return {x: _xMean, y: _yMean};
        }

        function reOrderArray(_arr){
            var _returnArray = [];
            
            var _yMax = 0;
            var _maxIndex = -1;
            for(var i=0; i<_arr.length; i++){
                if(_arr[i].y > _yMax){
                    _yMax = _arr[i].y;
                    _maxIndex = i;
                }
            }

            if(_maxIndex == 0){
                _returnArray = _arr;
            }
            else{
            var _arrFront = _arr.slice(0, _maxIndex);
            var _arrEnd = _arr.slice(_maxIndex, _arr.length);
            
            _returnArray = _arrEnd.concat(_arrFront);
           }

            return _returnArray;
        }


        var emptyWattTrj = [];
        function makeWattSet(_start, _end){
            var START_COUNT_FILE = _start;
            var END_COUNT_FILE = _end;
            
            console.log("START FROM: " + START_COUNT_FILE);
            console.log("END AT: " + END_COUNT_FILE);

            // array of a1, a2, p1, p2, p3, r1, r2
            // sample
            //_parr = [{x: 0.00, y: 0.00}, {x: 101.60, y: 0.00}, {x: 0.00, y: 38.10}, {x: 101.60, y: 76.20}, {x: 50.80, y: 50.80}, {x: 101.60, y: 0.00}, {x: 76.20, y: 25.40}]
            
            // starting point
            var _a1 = {x: 0, y: 0};
            var _a2 = {x: 50, y: 0};
            var _p1 = {x: 0, y: 25};
            var _p2 = {x: 50, y: 50};
            var _p3 = {x: 25, y: 25};
            var _c1 = {x: 50, y: 0};
            var _c2 = {x: 40, y: 15};
            
            var _count=0;
            
            // p1.y
            for(var p1y=0; p1y<=10; p1y+=10){
                // c1.y
                //for(var c1y=-_ANGLE_MAX; c1y<_ANGLE_MAX; c1y+=_STEP*2){
                // p3.x, p3.y
                for(var _r=30; _r<=50; _r+=10){
                    for(var _angle=0; _angle<(2*Math.PI); _angle+=(Math.PI/16)){
                        var p3x = _r*Math.cos(_angle);
                        var p3y = _r*Math.sin(_angle);
                        // c2.x
                        for(var _r2=60; _r2<=80; _r2+=10){
                            for(var _angle2=0; _angle2<(2*Math.PI); _angle2+=(Math.PI/16)){
                                var c2x = _r2*Math.cos(_angle2);
                                var c2y = _r2*Math.sin(_angle2);
                            
                                _a1t = {x: _a1.x,           y: _a1.y       };
                                _a2t = {x: _a2.x,           y: _a2.y       };
                                _p1t = {x: _p1.x,           y: _p1.y + p1y };
                                _p2t = {x: _a2t.x,          y: _p2.y       };
                                _c1t = {x: _a2t.x,          y: _c1.y       };
                            
                                _p3t = {x: (_p1t.x+_p2t.x)/2 + p3x,   y: (_p1t.y+_p2t.y)/2 + p3y};
                                _c2t = {x: (_c1t.x+_p3t.x)/2 + c2x,   y: (_c1t.y+_p3t.y)/2 + c2y};
                                
                                _parr = [_a1t, _a2t, _p1t, _p2t, _p3t, _c1t, _c2t];
                            
                                for(var i=0; i<8; i++){
                                
                                    // ================== EDITED
                                
                                    if(_count>=START_COUNT_FILE && _count<END_COUNT_FILE){
                                        generateWatt(emptyWattTrj, _parr, 0, ((2*Math.PI)/8)*i);
                                        generateWatt(emptyWattTrj, _parr, 1, ((2*Math.PI)/8)*i); //reverse
                                    }
                                    _count++;
                                    }
                                
                                    if(_count>=START_COUNT_FILE && _count<END_COUNT_FILE){
                                        var _text = "[";
                                        for(var i=START_COUNT_FILE; i<END_COUNT_FILE; i+=((END_COUNT_FILE-START_COUNT_FILE)/20)){
                                            if(i<_count){
                                                _text += "■";
                                            }else{
                                                _text += "□";
                                            }
                                        }
                                        _text += "] " + parseInt(((_count-START_COUNT_FILE)/(END_COUNT_FILE-START_COUNT_FILE))*100) +"%";
                                        console.log(_text);
                                    }
                                    //console.log("Training: " + emptyWattTrj.length);
                                }
                            }
                        }
                    }
                //}
            }


            console.log("total Count: " + _count);
            console.log("Generated Samples: " + emptyWattTrj.length);

            var _generatedData = "";
            for(i=0; i<emptyWattTrj.length; i++){
                _generatedData += JSON.stringify(emptyWattTrj[i]) + "\r\n";
            }
            saveAsText("WattDataSet"+START_COUNT_FILE+"_"+END_COUNT_FILE+"_"+(emptyWattTrj.length)+".txt", _generatedData);

            makeNewFile();
        }

        // generate and save watt;
        function generateWatt(_dataSet, _parr, _dir, _angle){
            //a1: anchor point for crank (driver)
            //a2: anchor point for rocker
            //p1: end point of crank
            //p2: end point of rocker
            //p3: end point of coupler (triangle)
            //r1: end point of watt rocker
            //r2: link point between r1 and p3
            //actual movement: link between r2 and p3

            // array of a1, a2, p1, p2, p3, r1, r2
            // sample
            //_parr = [{x: 0.00, y: 0.00}, {x: 101.60, y: 0.00}, {x: 0.00, y: 38.10}, {x: 101.60, y: 76.20}, {x: 50.80, y: 50.80}, {x: 101.60, y: 0.00}, {x: 76.20, y: 25.40}]

            if(_angle!=0){
                var _rotatedPArr = [];
                for(var i=0; i<_parr.length; i++){
                    _rotatedPArr.push(rotateFromOrigin(_parr[i], _angle));
                }
                _parr = _rotatedPArr;
            }

            drawWatt_generate(_parr, _dir, _angle, 0);

            // break test
            var isBroken = false;
            if(currentAssemblyGroup.try360() == Number.POSITIVE_INFINITY){
                isBroken = true;
                return false; // stop here for broken linkages
            }
            if(currentAssemblyGroup.assembly.getUnspecified().length()>0) return false;

            // get trajectories
            var _sampleSize = WATT_SAMPLE_SIZE;
            var positionTrj = resample(currentAssemblyGroup.getTrajectory().get(0).getTrajectory(), _sampleSize); // base position
            var handleTrj = resample(currentAssemblyGroup.getTrajectory().get(1).getTrajectory(), _sampleSize); // handle position
            var targetTrj = resample(currentAssemblyGroup.getTrajectory().get(2).getTrajectory(), _sampleSize); // target position

            if(isNaN(handleTrj[0].x)) return false;

            var _trjData = normalizeTrj(targetTrj);

            // get angles
            var angleArrays = getAngleVariation(positionTrj, handleTrj);
            var _angleData = normalizeAngle(angleArrays);
            
            _dataSet.push({points: _parr,
            trajectory: _trjData.trajectory,
            angle: _angleData.angle,
            width: _trjData.width,
            dx: _trjData.dx,
            dy: _trjData.dy,
            da: _angleData.da,
            dir: _dir
            });
        }

            var emptyFourbarTrj = [];
        function makeFourbarSet(_start, _end){
            var START_COUNT_FILE = _start;
            var END_COUNT_FILE = _end;
            
            console.log("START FROM: " + START_COUNT_FILE);
            console.log("END AT: " + END_COUNT_FILE);
            
            // array of a1, a2, p1, p2, p3
            // sample
            //_parr = [{x: 0.00, y: 0.00}, {x: 101.60, y: 0.00}, {x: 0.00, y: 38.10}, {x: 101.60, y: 76.20}, {x: 50.80, y: 50.80}]
            
            // starting point
            var _a1 = {x: 0, y: 0};
            var _a2 = {x: 50, y: 0};
            var _p1 = {x: 0, y: 25};
            var _p2 = {x: 50, y: 50};
            var _p3 = {x: 25, y: 25};
            
            var _count=0;
            // p3.x, p3.y
        for(var _r=30; _r<=50; _r+=20){
        for(var _angle=0; _angle<(2*Math.PI); _angle+=(Math.PI/16)){
            var p3x = _r*Math.cos(_angle);
            var p3y = _r*Math.sin(_angle);
            
            _a1t = {x: _a1.x,           y: _a1.y       };
            _a2t = {x: _a2.x,           y: _a2.y       };
            _p1t = {x: _p1.x,           y: _p1.y       };
            _p2t = {x: _a2t.x,          y: _p2.y       };
            _p3t = {x: (_p1t.x+_p2t.x)/2 + p3x,   y: (_p1t.y+_p2t.y)/2 + p3y};
            
            _parr = [_a1t, _a2t, _p1t, _p2t, _p3t];

            for(var i=0; i<8; i++){
            
                if(_count>=START_COUNT_FILE && _count<END_COUNT_FILE){
                    generateFourbar(emptyFourbarTrj, _parr, 0, ((2*Math.PI)/8)*i);
                    generateFourbar(emptyFourbarTrj, _parr, 1, ((2*Math.PI)/8)*i); //reverse
                }
                _count++;
            }

            if(_count>=START_COUNT_FILE && _count<END_COUNT_FILE){
                var _text = "[";
                for(var i=START_COUNT_FILE; i<END_COUNT_FILE; i+=((END_COUNT_FILE-START_COUNT_FILE)/20)){
                    if(i<_count){
                        _text += "■";
                    }else{
                        _text += "□";
                    }
                }
                _text += "] " + parseInt(((_count-START_COUNT_FILE)/(END_COUNT_FILE-START_COUNT_FILE))*100) +"%";
                console.log(_text);
            }
            //console.log("Training: " + emptyFourbarTrj.length);
            }
        }

            console.log("total Count: " + _count);
            console.log("Generated Samples: " + emptyFourbarTrj.length);
            
            var _generatedData = "";
            for(i=0; i<emptyFourbarTrj.length; i++){
                _generatedData += JSON.stringify(emptyFourbarTrj[i]) + "\r\n";
            }
                saveAsText("FourbarDataSet"+START_COUNT_FILE+"_"+END_COUNT_FILE+"_"+(emptyFourbarTrj.length)+".txt", _generatedData);
            
            makeNewFile();
        }

        // generate and save watt;
        function generateFourbar(_dataSet, _parr, _dir, _angle){
            //a1: anchor point for crank (driver)
            //a2: anchor point for rocker
            //p1: end point of crank
            //p2: end point of rocker
            //p3: end point of coupler (triangle)
            
            // array of a1, a2, p1, p2, p3,
            // sample
            //_parr = [{x: 0.00, y: 0.00}, {x: 101.60, y: 0.00}, {x: 0.00, y: 38.10}, {x: 101.60, y: 76.20}, {x: 50.80, y: 50.80},]

            if(_angle!=0){
                var _rotatedPArr = [];
                for(var i=0; i<_parr.length; i++){
                    _rotatedPArr.push(rotateFromOrigin(_parr[i], _angle));
                }
                _parr = _rotatedPArr;
            }

            drawFourbar(_parr, _dir, _angle, 0);

            // break test
            var isBroken = false;
            if(currentAssemblyGroup.try360() == Number.POSITIVE_INFINITY){
                isBroken = true;
                return false; // stop here for broken linkages
            }
            if(currentAssemblyGroup.assembly.getUnspecified().length()>0) return false;

            // get trajectories
            var _sampleSize = FOURBAR_SAMPLE_SIZE;
            var positionTrj = resample(currentAssemblyGroup.getTrajectory().get(0).getTrajectory(), _sampleSize); // base position
            
            var _trjData = normalizeTrj(positionTrj);
            
            _dataSet.push({points: _parr,
            trajectory: _trjData.trajectory,
            //angle: _angleData.angle,
            width: _trjData.width,
            dx: _trjData.dx,
            dy: _trjData.dy,
            //da: _angleData.da,
            dir: _dir
            });
        }

        function rotateFromOrigin(_p, _theta){
            var _qx = _p.x * Math.cos(_theta) - _p.y * Math.sin(_theta);
            var _qy = _p.x * Math.sin(_theta) + _p.y * Math.cos(_theta);
            
            return {x: _qx, y: _qy};
        }

        // function for get angle array between two points
        function getAngleVariation(_ptrj, _htrj){
            var _returnAngles = [];

            for(var i=0; i<_ptrj.length; i++){
                var _angle = Math.atan2(_htrj[i].y-_ptrj[i].y, _htrj[i].x-_ptrj[i].x);
            
                if(_angle < 0)  _angle += (2 * Math.PI);
                    _angle = _angle%(2*Math.PI);
                    
                    _returnAngles.push(_angle);
                }
                return _returnAngles;
            }

        // DTW Prepare
        function normalizeTrj(_data) {
            // normalize trj with max width 1
            
            var _returnTrj = [];
            
            var _xMean = 0;
            var _yMean = 0;
            var _xMax = Number.NEGATIVE_INFINITY;
            var _xMin = Number.POSITIVE_INFINITY;

            for (var i = 0; i < _data.length; i++) {
                _xMean = _xMean + _data[i].x;
                _yMean = _yMean + _data[i].y;
                if(_data[i].x > _xMax) _xMax = _data[i].x;
                if(_data[i].x < _xMin) _xMin = _data[i].x;
            }
            _xMean = _xMean / _data.length;
            _yMean = _yMean / _data.length;
            
            var _width = _xMax - _xMin;

            for (var i = 0; i < _data.length; i++) {
                _returnTrj.push({x: ((_data[i].x - _xMean)/_width).toFixed(4), y: ((_data[i].y - _yMean)/_width).toFixed(4)});
            }
            return {trajectory: _returnTrj, width: _width, dx: _xMean, dy: _yMean};
        }

        function normalizeAngle(_data) {
            var _returnAngle = [];
            
            var _aMean = 0;

            for (var i = 0; i < _data.length; i++) {
                _aMean = _aMean + _data[i]
            }
            _aMean = _aMean / _data.length;

            /*
            for (var i = 0; i < _data.length; i++) {
                _returnAngle.push(_data[i] - _aMean);
            }
            */

            for (var i = 0; i < _data.length; i++) {
                _returnAngle.push( (_data[i] - _data[0]).toFixed(4) ); // starting from 0
            }

            return {angle: _returnAngle, da: _aMean};
        }

        // distance function
        function distFuncTrj( a, b ) {
            var xdiff = a.x - b.x;
            var ydiff = a.y - b.y;
            
            var diff = Math.sqrt(xdiff*xdiff + ydiff*ydiff);
            return diff;
        }
        function distFuncAngle( a, b ) {
            var adiff = a - b;
            
            var diff = Math.abs(adiff);
            return diff;
        }

        // DTW library
        ( function() {
        "use strict";
        function DynamicTimeWarping ( ts1, ts2, distanceFunction ) {
            var ser1 = ts1;
            var ser2 = ts2;
            var distFunc = distanceFunction;
            var distance;
            var matrix;
            var path;

        var getDistance = function() {
            if ( distance !== undefined ) {
                return distance;
            }
        ;
            //console.log(ser1)
            //console.log(ser1.length)
            //console.log(ser2)
            //console.log(ser2.length)
            matrix = [];
        for ( var i = 0; i < ser1.length; i++ ) {
            matrix[ i ] = [];
        for ( var j = 0; j < ser2.length; j++ ) {
            var cost = Infinity;
            if ( i > 0 ) {
                cost = Math.min( cost, matrix[ i - 1 ][ j ] );
                if ( j > 0 ) {
                cost = Math.min( cost, matrix[ i - 1 ][ j - 1 ] );
                cost = Math.min( cost, matrix[ i ][ j - 1 ] );
              }
            } else {
                if ( j > 0 ) {
                    cost = Math.min( cost, matrix[ i ][ j - 1 ] );
                } else {
                    cost = 0;
                }
            }
            matrix[ i ][ j ] = cost + distFunc( ser1[ i ], ser2[ j ] );
            }
        }

            return matrix[ ser1.length - 1 ][ ser2.length - 1 ];
        };

            this.getDistance = getDistance;

        var getPath = function() {
            if ( path !== undefined ) {
                return path;
            }
            if ( matrix === undefined ) {
                getDistance();
            }
            var i = ser1.length - 1;
            var j = ser2.length - 1;
            path = [ [ i, j ] ];
        while ( i > 0 || j > 0 ) {
        if ( i > 0 ) {
            if ( j > 0 ) {
                if ( matrix[ i - 1 ][ j ] < matrix[ i - 1 ][ j - 1 ] ) {
                    if ( matrix[ i - 1 ][ j ] < matrix[ i ][ j - 1 ] ) {
                        path.push( [ i - 1, j ] );
                        i--;
                    } else {
                        path.push( [ i, j - 1 ] );
                        j--;
                    }
                } else {
                if ( matrix[ i - 1 ][ j - 1 ] < matrix[ i ][ j - 1 ] ) {
                    path.push( [ i - 1, j - 1 ] );
                    i--;
                    j--;
                } else {
                    path.push( [ i, j - 1 ] );
                    j--;
                }
            }
            } else {
                path.push( [ i - 1, j ] );
                i--;
        }
        } else {
            path.push( [ i, j - 1 ] );
            j--;
        }
        }
            path = path.reverse();

            return path;
        };

        this.getPath = getPath;
        }

        var root = typeof self === "object" && self.self === self && self ||
        typeof global === "object" && global.global === global && global ||
        this;

        if ( typeof exports !== "undefined" && !exports.nodeType ) {
        if ( typeof module !== "undefined" && !module.nodeType && module.exports ) {
            exports = module.exports = DynamicTimeWarping;
        }
            exports.DynamicTimeWarping = DynamicTimeWarping;
        } else {
            root.DynamicTimeWarping = DynamicTimeWarping;
        }

        if ( typeof define === "function" && define.amd ) {
            define( "dynamic-time-warping", [], function() {
            return DynamicTimeWarping;
        } );
        }
        }() );


        </script>
        
        <!-- Linkage generation panel
        updated by yunwoo jeong -->
        <!-- yw_edited -->
        
        <div class="msketch-panel-container" id="panel_fab" style="display: none">
        <div class="msketch-panel-title">Fabrication</div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc">Generate the 3D links and gears. Use 'Edit Link' tool to select a link</div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc" style="font-weight: 700">3D Link Generation</div>
        <label class="form-switch">
        <input type="checkbox" id="panel_fab_Show3DLink">
        <i class="form-icon"></i> <span class="msketch-panel-desc">Show 3D Link</span>
        </label>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-btn-text">Stacking Order</div>
        <button class="msketch-panel-btn" id="btn_stackPlus"><i class="material-icons">add_circle_outline</i></button>
        <button class="msketch-panel-btn" id="btn_stackMinus"><i class="material-icons">remove_circle_outline</i></button>
        </div>
        <button class="msketch-panel-btn-large" id="panel_fab_downloadLink"><i class="material-icons">file_download</i>Download Links (OBJ)</button>
        <hr>
        
        <div class="msketch-panel-desc" style="font-weight: 700">Gear Generation</div>
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn-large" id="panel_fab_generateGear" style="width: 47%; display:inline-block; float: left"><i class="material-icons">done</i>Generate</button>
        <button class="msketch-panel-btn-large" id="panel_fab_removeGear" style="width: 47%; display:inline-block; float: right"><i class="material-icons">remove</i>Remove</button>
        </div>
        <button class="msketch-panel-btn-large" id="panel_fab_downloadGear"><i class="material-icons">file_download</i>Download Gears (OBJ)</button>
        
        </div>
        
        <script>
            $('#panel_fab_Show3DLink').on('change', function(){
                show3Dlinks( $(this).prop('checked') );
            })

            $('#btn_stackPlus').click(function(){
              if(selectedLink==null) return false;
                var _link = currentAssemblyGroup.findObjectFromElement(selectedLink);
                if(_link != null){
                    selectedLink.stack++;
                    _link.updateStack();
                }
            });

            $('#btn_stackMinus').click(function(){
              if(selectedLink==null) return false;
                var _link = currentAssemblyGroup.findObjectFromElement(selectedLink);
                if(_link != null){
                    selectedLink.stack--;
                    _link.updateStack();
                }
            });

            $('#panel_fab_downloadLink').click(function(){
              var exporter = new THREE.OBJExporter();
              for(var i in currentAssemblyGroup.objectList){
                  if(currentAssemblyGroup.objectList[i] instanceof Link3D){
                    var _mesh = currentAssemblyGroup.objectList[i].link3DObject
                    _mesh.geometry.scale(SCALE_TRANS, SCALE_TRANS, SCALE_TRANS);
                    var result = exporter.parse( _mesh );
                    _mesh.geometry.scale(1/SCALE_TRANS, 1/SCALE_TRANS, 1/SCALE_TRANS);

                    saveAsText('mSketchLink'+i+'.obj', result);
                  }
              }
            });

            $('#panel_fab_generateGear').click(function(){
              currentAssemblyGroup.makeGear();
            });

            $('#panel_fab_removeGear').click(function(){
              currentAssemblyGroup.removeGear();
            });

            $('#panel_fab_downloadGear').click(function(){
              var exporter = new THREE.OBJExporter();
              for(var i in currentAssemblyGroup.gearObjList){
                  if(currentAssemblyGroup.gearObjList[i] instanceof Gear3D){
                      var _mesh = currentAssemblyGroup.gearObjList[i].gearObject;
                      _mesh.geometry.scale(SCALE_TRANS, SCALE_TRANS, SCALE_TRANS);
                      var result = exporter.parse( _mesh );
                      _mesh.geometry.scale(1/SCALE_TRANS, 1/SCALE_TRANS, 1/SCALE_TRANS);

                      saveAsText('mSketchGear'+i+'.obj', result);
                  }
              }
            });

            function show3Dlinks(_flag){
                Link3D.SHOW_3D = _flag;

                for(var i in AssemblyGroupList){
                    AssemblyGroupList[i].updateRender();
                    AssemblyGroupList[i].update();
                }
            }

        </script>
        
        <div class="msketch-panel-container" id="panel_load" style="display: none">
        <div class="msketch-panel-title">Load<br>Setting</div>
        
        <div class="msketch-panel-row">
        <button class="msketch-panel-btn" id="btn_addload" onclick="interfaceSelect(TOOL_ADDLOAD);" data-tooltip="Add Load"><i class="material-icons">add_circle_outline</i></button>
        <div class="msketch-panel-btn-text">Add</div>
        <button class="msketch-panel-btn" id="btn_editload" onclick="interfaceSelect(TOOL_EDITLOAD);" data-tooltip="Edit Load"><i class="material-icons">edit</i></button>
        <div class="msketch-panel-btn-text">Edit</div>
        <button class="msketch-panel-btn" id="btn_removeload" onclick="interfaceSelect(TOOL_REMOVELOAD);" data-tooltip="Remove Load"><i class="material-icons">remove_circle_outline</i></button>
        <div class="msketch-panel-btn-text">Remove</div>
        </div>
        
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Fx [N]" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_load_valueX" disabled>
        </div>
        <div class="msketch-panel-label" data-label="Fy [N]" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="panel_load_valueY" disabled>
        </div>
        </div>
        
        <button class="msketch-panel-btn-large" id="panel_load_apply"><i class="material-icons">done</i>Apply</button>
        <button class="msketch-panel-btn-large" id="panel_load_download"><i class="material-icons">file_download</i>Download Load Data</button>
        </div>
        
        <script>
        // === Load Panel ===
        $('#btn_addload').click(function(){
        $('#panel_load_valueX').prop('disabled', true);
        $('#panel_load_valueY').prop('disabled', true);
        });
        $('#btn_removeload').click(function(){
        $('#panel_load_valueX').prop('disabled', true);
        $('#panel_load_valueY').prop('disabled', true);
        });

        $('#panel_load_apply').click( function(){
        applyLoad();
        });

        $('#panel_load').keyup(function(event){
        if (event.keyCode == 13) {
        applyLoad();
        }
        });

        $('#panel_load_download').click( function(){
        downloadLoadData();
        });



        var prevPosition 	= [];
        var prevPointPair 	= null;

        function getLoadInfoToLoadPanel(_valueX , _valueY){
        if(!(toolState==TOOL_EDITLOAD)) return;
        $('#panel_load_valueX').prop('disabled', false);
        $('#panel_load_valueX').val(_valueX);
        $('#panel_load_valueY').prop('disabled', false);
        $('#panel_load_valueY').val(_valueY);
        }

        function applyLoad(){
        if(!(toolState==TOOL_EDITLOAD)) return;
        var newLoadValX = parseFloat($('#panel_load_valueX').val());
        var newLoadValY = parseFloat($('#panel_load_valueY').val());
        currentAssemblyGroup.loadList.get(loadIndex).setLoadX(newLoadValX);
        currentAssemblyGroup.loadList.get(loadIndex).setLoadY(newLoadValY);
        currentAssemblyGroup.load();
        try360forAssemblies();
        }

        function downloadLoadData(){
        var dataOut = JSON.parse(getMsketchInfoForPlane());

        var loadData = [];
        for(var i=0; i<currentAssemblyGroup.loadList.length(); i++){
        var tempLoads = {};
        tempLoads.x = (currentAssemblyGroup.loadList.get(i).getGlobalPosition().x*SCALE_TRANS).toFixed(2);
        tempLoads.y = (currentAssemblyGroup.loadList.get(i).getGlobalPosition().y*SCALE_TRANS).toFixed(2);
        tempLoads.loadX = currentAssemblyGroup.loadList.get(i).getLoadX();
        tempLoads.loadY = currentAssemblyGroup.loadList.get(i).getLoadY();
        loadData.push(tempLoads);
        }

        dataOut.sketch.loads =  loadData;

        dataOut = JSON.stringify(dataOut, null, '\t');

        saveAsText($('#msketch-titlebar-filename').val()+"_Load"+findCurrentAssemblyNum()+".json", dataOut);
        }

        </script>
        
        <div class="msketch-panel-container" id="panel_settings" style="display: none">
        <div class="msketch-panel-title">Settings</div>
        
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc" style="font-weight: 700">View</div>
        <label class="form-switch">
        <input type="checkbox" id="setting_showGrid">
        <i class="form-icon"></i> <span class="msketch-panel-desc">Show Grid</span>
        </label>
        <label class="form-switch">
        <input type="checkbox" id="setting_showText">
        <i class="form-icon"></i> <span class="msketch-panel-desc">Show Length Text</span>
        </label>
        <label class="form-switch">
        <input type="checkbox" id="setting_showPlane">
        <i class="form-icon"></i> <span class="msketch-panel-desc">Show Plane</span>
        </label>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Grid Gap (mm)" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="setting_gridGap">
        </div>
        <div class="msketch-panel-label" data-label="Plane Size (mm)" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="setting_planeSize">
        </div>
        </div>
        <hr>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc" style="font-weight: 700">Part</div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Hole Dia. (mm)" style="width: 100%;">
        <input class="form-input msketch-panel-input" type="text" id="setting_holeDiameter">
        </div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Link Width (mm)" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="setting_linkWidth">
        </div>
        <div class="msketch-panel-label" data-label="Link Thickness (mm)" style="width: 49%;">
        <input class="form-input msketch-panel-input" type="text" id="setting_linkThickness">
        </div>
        </div>
        <hr>
        <div class="msketch-panel-row">
        <div class="msketch-panel-desc" style="font-weight: 700">System</div>
        </div>
        <div class="msketch-panel-row">
        <div class="msketch-panel-label" data-label="Max History Size" style="width: 100%;">
        <input class="form-input msketch-panel-input" type="text" id="setting_maxHistory">
        </div>
        </div>
        
        <button class="msketch-panel-btn-large" id="setting_apply"><i class="material-icons">done</i>Apply</button>
        </div>
        
        <script>

        $('#setting_apply').click( function(){
        applySettings();
        });

        function loadSettings(){
        $('#setting_showGrid').prop('checked', msketchSettings.showGrid);
        $('#setting_showText').prop('checked', msketchSettings.showText);
        $('#setting_showPlane').prop('checked', msketchSettings.showPlane);

        $('#setting_gridGap').val( msketchSettings.gridGap );
        $('#setting_planeSize').val( msketchSettings.planeSize );

        $('#setting_holeDiameter').val( msketchSettings.holeDiameter );
        $('#setting_linkWidth').val( msketchSettings.linkWidth );
        $('#setting_linkThickness').val( msketchSettings.linkThickness );

        $('#setting_maxHistory').val( msketchSettings.MaxHistorySize );
        }

        function initSettings(){
        $.ajax({
        url: '/loadSettings',
        method: 'post',
            success: function (data) {
                msketchSettings = JSON.parse(data.settings);
            
            // apply settings
            MAX_HISTORY = parseInt( msketchSettings.MaxHistorySize );

            for(var i=0; i<AssemblyGroupList.length; i++){
                AssemblyGroupList[i].setSettings(msketchSettings);
                AssemblyGroupList[i].needsUpdate = true;
                AssemblyGroupList[i].load();
            }
        },
            error: function (err) {
                showMessage("Setting Load failed");
            }
        });
        }

        function applySettings(){
            msketchSettings.showGrid = $("#setting_showGrid").prop("checked");
            msketchSettings.showText = $("#setting_showText").prop("checked");
            msketchSettings.showPlane = $("#setting_showPlane").prop("checked");
            
            msketchSettings.gridGap = parseFloat( $('#setting_gridGap').val() );
            msketchSettings.planeSize = parseFloat( $('#setting_planeSize').val() );
            
            msketchSettings.holeDiameter = parseFloat( $('#setting_holeDiameter').val() );
            msketchSettings.linkWidth = parseFloat( $('#setting_linkWidth').val() );
            msketchSettings.linkThickness = parseFloat( $('#setting_linkThickness').val() );

        //apply setting to 3D link (yw_edited)
        Link3D.HEIGHT = msketchSettings.linkThickness;
        Link3D.EXTRUDE_SET.amount = msketchSettings.linkThickness;
        Link3D.HOLE_SIZE = (msketchSettings.holeDiameter/SCALE_TRANS)/2;

        msketchSettings.MaxHistorySize = parseInt( $('#setting_maxHistory').val() );

        $.ajax({
            url: '/saveSettings',
            method: 'post',
            data: {
            settings: JSON.stringify(msketchSettings, null, '\t')
        },
        success: function (data) {
            showMessage("Setting was applied.");
            initSettings();
        },
            error: function (err) {
                showMessage("Setting save failed");
            }
        });

        }

        </script>
        
        <div id="panel_close_btn"><i class="material-icons">close</i></div>
        </div>
        
        <script>
        $('#panel_close_btn').click(function(){
        $('#msketch_panel').removeClass('expand');
        removePanelActiveClass();
        });

        $('#btn_panel_move').click(function(){
        removePanelActiveClass();
        $('#btn_panel_move').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_move').show();
        });

        $('#btn_panel_plane').click(function(){
        removePanelActiveClass();
        $('#btn_panel_plane').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_plane').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_motor').click(function(){
        removePanelActiveClass();
        $('#btn_panel_motor').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_motor').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_pattern').click(function(){
        removePanelActiveClass();
        $('#btn_panel_pattern').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_pattern').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_analysis').click(function(){
        removePanelActiveClass();
        $('#btn_panel_analysis').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_analysis').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_opt').click(function(){
        removePanelActiveClass();
        $('#btn_panel_opt').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_opt').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_gen').click(function(){
        removePanelActiveClass();
        $('#btn_panel_gen').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_gen').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_fab').click(function(){
        removePanelActiveClass();
        $('#btn_panel_fab').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_fab').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_panel_load').click(function(){
        removePanelActiveClass();
        $('#btn_panel_load').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_load').show();
        getPlaneInfoToPlanePanel();
        });

        $('#btn_settings').click(function(){
        removePanelActiveClass();
        $('#btn_settings').addClass('active');
        $('#msketch_panel').addClass('expand');
        $('#panel_settings').show();
        getPlaneInfoToPlanePanel();

        loadSettings();
        });

        function removePanelActiveClass(){
        $('.msketch-sidebar').children().removeClass('active');
        $('#msketch_panel').children().hide();
        $('#panel_close_btn').show();
        };
        </script>
        
        <div id="threejs_canvas"></div>
        
        <div class="msketch-message" id="msketch_message"></div>
        
        <script>
        function showMessage(_msg){
        $('#msketch_message').text(_msg);
        //$('#msketch_message').animate({bottom: "0"}, 300)
        $('#msketch_message').css('bottom', 0);

        setTimeout(function(){
        $('#msketch_message').css('bottom', '-48px');
        },2000);
        }
        </script>
        
        <div class="msketch-dialog" id="dialog_newFile">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">New File</div>
        <div class="msketch-dialog-text">Remove all current assemblies and create new file.</div>
        <button class="msketch-dialog-btn" id="dialog_newFile_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_newFile').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_newFile">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">New File</div>
        <div class="msketch-dialog-text">Remove all current assemblies and create new file.</div>
        <button class="msketch-dialog-btn" id="dialog_newFile_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_newFile').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_openFile">
        <div class="msketch-dialog-box" style="width: 600px">
        <div class="msketch-dialog-header">Open File</div>
        <div class="msketch-dialog-text">Remove all assemblies and open existing file.</div>
        <div style="float: right;">
        <button class="msketch-toolbar-btn" id="dialog_openFile_download" data-tooltip="Download"><i class="material-icons">cloud_download</i></button>
        <button class="msketch-toolbar-btn" id="dialog_openFile_upload" data-tooltip="Upload"><i class="material-icons">cloud_upload</i></button>
        <button class="msketch-toolbar-btn" id="dialog_openFile_rename" data-tooltip="Rename" style="display: none"><i class="material-icons">title</i></button>
        <button class="msketch-toolbar-btn" id="dialog_openFile_delete" data-tooltip="Delete"><i class="material-icons">delete</i></button>
        </div>
        
        <select id="dialog_fileList" class="form-select msketch-dialog-select" name='files' size='10'>
        </select>
        
        <button class="msketch-dialog-btn" id="dialog_openFile_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_openFile').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_uploadFile">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">Upload File</div>
        <div class="msketch-dialog-text">File Uploader</div>
        
        <input type=file id="dialog_uploadFile_file" class="form-input msketch-panel-input" />
        
        <button class="msketch-dialog-btn" id="dialog_uploadFile_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_uploadFile').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_importPlane">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">Import Plane</div>
        <div class="msketch-dialog-text">Upload Plane File</div>
        
        <input type=file id="dialog_importPlane_file" class="form-input msketch-panel-input" />
        
        <button class="msketch-dialog-btn" id="dialog_importPlane_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_importPlane').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_deleteFile">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">Delete File</div>
        <div class="msketch-dialog-text">File will be deleted: </div>
        <div class="msketch-dialog-text" id="dialog_deleteFile_fileName">Filename</div>
        
        <button class="msketch-dialog-btn" id="dialog_deleteFile_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_deleteFile').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_saveFile">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">Save File</div>
        <div class="msketch-dialog-text">Save file on M.Sketch server.</div>
        <div class="msketch-panel-label" data-label="File Name" style="width: 100%; margin-bottom: 12px">
        <input class="form-input msketch-panel-input" type="text" id="dialog_save_filename">
        </div>
        <button class="msketch-dialog-btn" id="dialog_save_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_saveFile').hide();">Cancel</button>
        </div>
        </div>
        
        <div class="msketch-dialog" id="dialog_pRemove">
        <div class="msketch-dialog-box">
        <div class="msketch-dialog-header">Remove Plane</div>
        <div class="msketch-dialog-text">Plane will be removed.</div>
        
        <button class="msketch-dialog-btn" id="dialog_pRemove_ok">OK</button>
        <button class="msketch-dialog-btn" onclick="$('#dialog_pRemove').hide();">Cancel</button>
        </div>
        </div>
        
        <div id="msketch_fileCache" style="display: none"></div>
        
        <script>
        var firstSaved = false;
        /* for dialog */
        function showDialog(_id){
        switch (_id) {
        case TOOL_NEWFILE:
        $('#dialog_newFile').show();
        break;
        case TOOL_PREMOVE:
        $('#dialog_pRemove').show();
        break;
        case TOOL_SAVE:
        if(!firstSaved){
        $('#dialog_saveFile').show();
        $('#dialog_save_filename').val( $('#msketch-titlebar-filename').val() );
        }else{
        saveFileIntoDB( $('#msketch-titlebar-filename').val() )
        }
        break;
        case TOOL_OPEN:
        $.ajax({
        url: '/loadFile',
        method: 'post',
        data: {},
        success: function (data) {
        $('#dialog_fileList').empty();
        $.each(data.list, function (i, item) {
                $('#dialog_fileList').append($('<option>', {
                    value: item,
                    text : item
                }));
            });
            //console.log(data.list);
        },
        error: function (err) {
            showMessage("File list load failed");
        }
        });
        $('#dialog_openFile').show();
        break;
        case TOOL_IMPORT:
        $('#dialog_importPlane').show();
        break;
        }
        }

        $('#dialog_newFile_ok').click(function(){
        interfaceSelect(TOOL_NEWFILE);
        $('#dialog_newFile').hide();
        });

        $('#dialog_pRemove_ok').click(function(){
        interfaceSelect(TOOL_PREMOVE);
        $('#dialog_pRemove').hide();
        });

        // OPEN DIALOG
        $('#dialog_openFile_ok').click(function(){
        console.log($('#dialog_fileList').val());
        if($('#dialog_fileList').val()==null){
        showMessage("No file selected.")
        }else{
        $.ajax({
        url: '/openFile',
        method: 'post',
        data: {fileName: $('#dialog_fileList').val()},
        success: function (data) {
        if(isPlaying)	interfaceSelect(TOOL_RUN);
        loadMsketchInfo(data.file, true);
        $('#msketch-titlebar-filename').val(data.name.replace(".json", ""));
        firstSaved = false;
        closeDrawer();
        },
        error: function (err) {
        showMessage("Open failed");
        }
        });
        }

        $('#dialog_openFile').hide();
        });

        $('#dialog_openFile_download').click(function(){
        if($('#dialog_fileList').val()==null){
        showMessage("No file selected.");
        }else{
        $.ajax({
        url: '/openFile',
        method: 'post',
        data: {fileName: $('#dialog_fileList').val()},
        success: function (data) {
        saveAsText(data.name, data.file);
        closeDrawer();
        },
        error: function (err) {
        showMessage("Save failed");
        }
        });
        }
        });

        $('#dialog_openFile_upload').click(function(){
        $('#dialog_uploadFile').show();
        });

        $('#dialog_uploadFile_ok').click(function(){
        var _file = $('#dialog_uploadFile_file')[0].files[0];
        var _reader = new FileReader();
        var _fileName = null;
        _reader.addEventListener("load", function() {

        $.ajax({
        url: '/save',
        method: 'post',
        data: {
        fileName: _fileName.replace(".json", ""),
        file: _reader.result
        },
        success: function (data) {
        showMessage("File was uploaded.");

        $.ajax({
            url: '/loadFile',
            method: 'post',
            data: {},
            success: function (data) {
                $('#dialog_fileList').empty();
                $.each(data.list, function (i, item) {
                        $('#dialog_fileList').append($('<option>', {
                            value: item,
                            text : item
                        }));
                    });
                    //console.log(data.list);
                },
                error: function (err) {
                    showMessage("File list load failed");
                }
            });
        },
        error: function (err) {
            showMessage("Save failed");
        }
        });


        }, false);

        if (_file) {
        _fileName = _file.name;
        _reader.readAsText(_file);
        }

        $('#dialog_uploadFile').hide();
        });


        $('#dialog_openFile_rename').click(function(){

        });

        $('#dialog_openFile_delete').click(function(){
        if($('#dialog_fileList').val()==null){
        showMessage("No file selected.")
        }else{
        $('#dialog_deleteFile').show();
        $('#dialog_deleteFile_fileName').text( $('#dialog_fileList').val() )
        }
        });

        $('#dialog_deleteFile_ok').click(function(){

        $.ajax({
        url: '/deleteFile',
        method: 'post',
        data: {fileName: $('#dialog_fileList').val()},
        success: function (data) {
        $('#dialog_fileList').empty();
        $.each(data.list, function (i, item) {
                $('#dialog_fileList').append($('<option>', {
                    value: item,
                    text : item
                }));
            });
            $('#dialog_deleteFile').hide();
        },
        error: function (err) {
            showMessage("Delete failed");
        }
        });
        });

        $('#dialog_importPlane_ok').click(function(){
        var _file = $('#dialog_importPlane_file')[0].files[0];
        var _reader = new FileReader();

        _reader.addEventListener("load", function() {
        var _data = JSON.parse(_reader.result);

        //check header
        if(_data.app != "EDISON" || _data.type != "Sketch"){
            showMessage("Wrong File");
            return null;
        }

        loadMsketchInfoForPlane(_data.sketch, true);
        }, false);

        if (_file) {
        _reader.readAsText(_file);
        }

        $('#dialog_importPlane').hide();
        })

        //SAVE DIALOG

        $('#dialog_save_ok').click(function(){
        $('#dialog_saveFile').hide();
        saveFileIntoDB( $('#dialog_save_filename').val() );
        });


        function saveFileIntoDB(_fileName){
        if(isPlaying)	interfaceSelect(TOOL_RUN);

        var _fileData = getMsketchInfo();

        $.ajax({
        url: '/save',
        method: 'post',
        data: {
            fileName: _fileName,
            file: _fileData
        },
        success: function (data) {
            showMessage("File was saved.");
            firstSaved = true;
        },
        error: function (err) {
            showMessage("Save failed");
        }
        });

        closeDrawer();
        }
        </script>
        
        <div class="msketch-dialog" id="msketch_about">
        <div class="msketch-dialog-box" style="width: 600px">
        <div class="msketch-login-logo">M.SKETCH</div>
        <div class="msketch-dialog-header" style="font-size: 18px">Version 3.0.180602 BETA</div>
        <div class="msketch-dialog-text">M.Sketch is a prototyping tool that supports non-experts to rapidly sketch, simulate a linkage-based mechanism, and transform it into a physical prototype. It provides intuitive interfaces for novice users without engineering knowledge and skills. M.Sketch has been developed as a Web-based computational design tool that is freely available on a public domain. It offers high device compatibility for PCs, tablets, and other mobile devices.</div>
            <div class="msketch-dialog-text" style="margin-bottom: 24px"><b>Authors</b><br>Han-Jong Kim, Yunwoo Jeong, Ju-Whan Kim, Tek-Jin Nam</div>
                <hr>
                <div class="msketch-dialog-text" style="font-size: 12px; font-style: italic">This research was supported by the EDISON Program through the National Research Foundation of Korea (NRF) funded by the Ministry of Science, ICT & Future Planning (No.2014M3C1A6038802).</div>
                <button class="msketch-dialog-btn" onclick="$('#msketch_about').hide();">Close</button>
            </div>
        </div>
        
        <script src="./public/libs/three.min.85.js"></script>
        <script src="./public/libs/OrbitControls.js"></script>
        <script src="./public/libs/Projector.js"></script>
        <script src="./public/libs/TransformControls.js"></script>
        <script src="./public/libs/CanvasRenderer.js"></script>
        <script src="./public/libs/jspdf.js"></script>
        <script src="./public/libs/FileSaver.js"></script>
        <script src="./public/libs/XMLWriter.js"></script>
        <script src="./public/libs/csg.js"></script>
        <script src="./public/libs/ThreeCSG.js"></script>
        <script src="./public/libs/OBJExporter.js"></script>

        <script src="./public/js/common/subs.js"></script>

        <script src="./public/js/core/constraints/Constraint.js"></script>
        <script src="./public/js/core/constraints/AngularConstraint.js"></script>
        <script src="./public/js/core/constraints/CoaxialConstraint.js"></script>
        <script src="./public/js/core/constraints/SliderConstraint.js"></script>

        <script src="./public/js/core/assembly/Assembly.js"></script>
        <script src="./public/js/core/assembly/LinkageGroup.js"></script>
        <script src="./public/js/core/assembly/MechanismCalculator.js"></script>

        <script src="./public/js/core/elements/MechElement.js"></script>
        <script src="./public/js/core/elements/Link.js"></script>
        <script src="./public/js/core/elements/Space.js"></script>
        <script src="./public/js/core/elements/JointActuator.js"></script>
        <script src="./public/js/core/elements/Trajectory.js"></script>
        <script src="./public/js/core/elements/Gear.js"></script>
        <script src="./public/js/core/elements/Load.js"></script>

        <script src="./public/js/core/threejs/AssemblyGroup.js"></script>
        <script src="./public/js/core/threejs/3DElements.js"></script>
        <script src="./public/js/core/threejs/ThreeSetup.js"></script>

        <script src="./public/js/core/interface/EventHandlers.js"></script>
        <script src="./public/js/core/interface/ToolSelect.js"></script>
        <script src="./public/js/core/interface/MouseInterface.js"></script>
        <script src="./public/js/core/interface/UndoAndRedo.js"></script>

        <script src="./public/js/core/io/FileIO.js"></script>
        <script src="./public/js/core/io/ExportDrawing.js"></script>

        <script src="./public/js/main.js"></script>

    </body>
</html>
